

<!DOCTYPE html>
<html lang="en" color-mode=light>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Java并发编程 - Hexo</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="google" content="notranslate" />
  <meta name="keywords" content=", 并发编程,多线程,锁">
  <meta name="description" content="Java并发编程课程说明
线程基础知识复习多线程为什么...">
  <meta name="author" content="John Doe">
  <link rel="icon" href="/images/icons/favicon-16x16.png" type="image/png" sizes="16x16">
  <link rel="icon" href="/images/icons/favicon-32x32.png" type="image/png" sizes="32x32">
  <link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png" sizes="180x180">
  <meta rel="mask-icon" href="/images/icons/stun-logo.svg" color="#333333">
  
    <meta rel="msapplication-TileImage" content="/images/icons/favicon-144x144.png">
    <meta rel="msapplication-TileColor" content="#000000">
  

  
<link rel="stylesheet" href="/css/style.css">


  
    
<link rel="stylesheet" href="https://at.alicdn.com/t/font_1445822_p6ry5n7lrr.css">

  

  
    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">

  

  
    
      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/xcode.min.css" name="highlight-style" mode="light">

      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/solarized-dark.min.css" name="highlight-style" mode="dark">

      
  

  <script>
    var CONFIG = window.CONFIG || {};
    var ZHAOO = window.ZHAOO || {};
    CONFIG = {
      isHome: false,
      fancybox: true,
      pjax: false,
      loading: {
        gif: '/images/theme/loading.gif',
        lottie: ''
      },
      lazyload: {
        enable: true,
        only_post: 'false',
        loading: {
          gif: '/images/theme/loading.gif',
          lottie: ''
        }
      },
      donate: {
        enable: false,
        alipay: 'https://pic.izhaoo.com/alipay.jpg',
        wechat: 'https://pic.izhaoo.com/wechat.jpg'
      },
      galleries: {
        enable: true
      },
      fab: {
        enable: true,
        always_show: false
      },
      carrier: {
        enable: false
      },
      daovoice: {
        enable: false
      },
      preview: {
        background: {
          default: '',
          api: ''
        },
        motto: {
          default: '我在开了灯的床头下，想问问自己的心啊。',
          typing: true,
          api: 'https://v2.jinrishici.com/one.json',
          data_contents: '["data","content"]'
        },
      },
      qrcode: {
        enable: true,
        type: 'url',
        image: 'https://pic.izhaoo.com/weapp-code.jpg',
      },
      toc: {
        enable: true
      },
      scrollbar: {
        type: 'default'
      },
      notification: {
        enable: false,
        delay: 4500,
        list: '',
        page_white_list: '',
        page_black_list: ''
      },
      search: {
        enable: true,
        path: '/search.xml'
      }
    }
  </script>

  

  

<meta name="generator" content="Hexo 5.4.2"></head>

<body class="lock-screen">
  <div class="loading" id="loading"></div>
  
    


  <nav class="navbar">
    <div class="left">
      
        <i class="iconfont iconhome j-navbar-back-home"></i>
      
      
        <i class="iconfont iconqrcode j-navbar-qrcode"></i>
      
      
        <i class="iconfont iconmoono" id="color-toggle" color-toggle="light"></i>
      
      
        <i class="iconfont iconsearch j-navbar-search"></i>
      
    </div>
    <div class="center">Java并发编程</div>
    <div class="right">
      <i class="iconfont iconmenu j-navbar-menu"></i>
    </div>
    
      <div id="qrcode-navbar"></div>
    
  </nav>

  
  

<nav class="menu">
  <div class="menu-container">
    <div class="menu-close">
      <i class="iconfont iconbaseline-close-px"></i>
    </div>
    <ul class="menu-content"><li class="menu-item">
        <a href="/ " class="underline "> 首页</a>
      </li><li class="menu-item">
        <a href="/galleries " class="underline "> 相册</a>
      </li><li class="menu-item">
        <a href="/archives " class="underline "> 归档</a>
      </li><li class="menu-item">
        <a href="/tags " class="underline "> 标签</a>
      </li><li class="menu-item">
        <a href="/categories " class="underline "> 分类</a>
      </li><li class="menu-item">
        <a href="/about " class="underline "> 关于</a>
      </li></ul>
    
      <div class="menu-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme - <a target="_blank" href="https://github.com/izhaoo/hexo-theme-zhaoo">zhaoo</a></p></div>
    
  </div>
</nav>
  <main id="main">
  <div class="article-wrap">
    <div class="row container">
      <div class="col-xl-3"></div>
      <div class="col-xl-6"><article class="article">
  <div class="wrap">
    <section class="head">
  <img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226171233.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  draggable="false">
  <div class="head-mask">
    <h1 class="head-title">Java并发编程</h1>
    <div class="head-info">
      <span class="post-info-item"><i class="iconfont iconcalendar"></i>February 25, 2022</span>
      
      <span class="post-info-item"><i class="iconfont iconfont-size"></i>59352</span>
    </div>
  </div>
</section>
    <section class="main">
      <section class="content">
        
        <h1 id="Java并发编程"><a href="#Java并发编程" class="headerlink" title="Java并发编程"></a>Java并发编程</h1><h2 id="课程说明"><a href="#课程说明" class="headerlink" title="课程说明"></a>课程说明</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105737.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104093439415"></p>
<h2 id="线程基础知识复习"><a href="#线程基础知识复习" class="headerlink" title="线程基础知识复习"></a>线程基础知识复习</h2><h3 id="多线程为什么那么重要"><a href="#多线程为什么那么重要" class="headerlink" title="多线程为什么那么重要"></a>多线程为什么那么重要</h3><p>硬件：摩尔定律失效</p>
<p>软件：异步回调的生产需求</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105738.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229093512959"></p>
<h3 id="start一个线程"><a href="#start一个线程" class="headerlink" title="start一个线程"></a>start一个线程</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105739.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229094556843"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105740.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229094614030"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105741.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229094622829"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105742.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229094642045"></p>
<h3 id="Java多线程相关概念"><a href="#Java多线程相关概念" class="headerlink" title="Java多线程相关概念"></a>Java多线程相关概念</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105743.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220110201647965"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112107.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20230226110138757"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112108.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229095753304"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112109.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229095944520"></p>
<h3 id="用户线程和守护线程"><a href="#用户线程和守护线程" class="headerlink" title="用户线程和守护线程"></a>用户线程和守护线程</h3><p>即便是写一个最简单的HelloWord程序，也会有两个线程：用户线程（main）和 守护线程（GC垃圾回收线程）</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105746.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229100546645"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105747.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229100603341"></p>
<h2 id="CompletableFuture"><a href="#CompletableFuture" class="headerlink" title="CompletableFuture"></a>CompletableFuture</h2><h3 id="Future和Callable接口"><a href="#Future和Callable接口" class="headerlink" title="Future和Callable接口"></a>Future和Callable接口</h3><p>Future接口定义了操作异步任务执行一些方法，如获取异步任务的执行结果、取消任务的执行、判断任务是否被取消、判断任务执行是否完毕等。 </p>
<p>Callable接口中定义了需要有返回的任务需要实现的方法。 比如主线程让一个子线程去执行任务，子线程可能比较耗时，启动子线程开始执行任务后，主线程就去做其他事情了，过了一会才去获取子任务的执行结果。</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105748.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229102351154"></p>
<h3 id="FutureTask"><a href="#FutureTask" class="headerlink" title="FutureTask"></a>FutureTask</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105749.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229102512122"></p>
<p>规范：system.out.println(futureTask.get())；放在最后</p>
<p>只要出现get方法，不管是否计算完成都阻塞等待结果完成再运行后面的代码</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105750.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229102541675"></p>
<h3 id="对Future的改进"><a href="#对Future的改进" class="headerlink" title="对Future的改进"></a>对Future的改进</h3><p>CompletableFuture的优点：</p>
<p>异步任务结束时，会自动回调某个对象的方法;</p>
<p>异步任务出错时，会自动回调某个对象的方法;</p>
<p>主线程设置好回调后，不再关心异步任务的执行，异步任务之间可以顺序执行</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105751.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229104116312"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105752.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229104138986"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105753.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229104230101"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105754.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229105819346"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105755.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229105833161"></p>
<h3 id="set、get-的区别"><a href="#set、get-的区别" class="headerlink" title="set、get 的区别"></a>set、get 的区别</h3><p>set和get基本上没啥区别，join不抛出异常</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105756.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229132059728"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105757.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229140513788"></p>
<h3 id="案例：电商网站性价需求"><a href="#案例：电商网站性价需求" class="headerlink" title="案例：电商网站性价需求"></a>案例：电商网站性价需求</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105758.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229132526164"></p>
<p>记录一次你项目中的一次亮点：</p>
<p>我做过一个比价需求，这个需求是要求我们去爬别的网站的数据，针对于同一件物品，看看他们在不同的网站上售价分别是多少。爬虫的兄弟提供给了我一些JOSN格式的数据，我自己做了一个HashMap（或Redis的zest中），做完数据清洁，保证没有重复数据之后，大概是有一万条数据。</p>
<p>针对这一万条数据，最笨的方法是全文扫描，一个一个的过，但是这样虽然可以实现，但是比较慢</p>
<p>后面了解到JUC里面有个CompletableFuture，可以做异步多线程并发，而且不阻塞，用它之后，就可以把网站的性能从xxx秒优化到xxx秒，这就是我技术上一个比较值得骄傲的亮点。</p>
<p>而且CompletableFuture默认使用的 forkjoin 的线程池，我自己手写了线程池，ThreadPollExactor，具体的参数根据自己的系统来定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.juc;<br><br><span class="hljs-keyword">import</span> jdk.nashorn.internal.objects.annotations.Getter;<br><br><span class="hljs-keyword">import</span> java.util.*;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;<br><span class="hljs-keyword">import</span> java.util.concurrent.ThreadLocalRandom;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span>: GengKY</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span>: 2021/12/29 13:29</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ComplateFutureNetMallDemo</span>&#123;<br><br>    <span class="hljs-keyword">static</span> List&lt;NetMall&gt; list= Arrays.asList(<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetMall</span>(<span class="hljs-string">&quot;JD&quot;</span>),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetMall</span>(<span class="hljs-string">&quot;PDD&quot;</span>),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetMall</span>(<span class="hljs-string">&quot;TaoBao&quot;</span>),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetMall</span>(<span class="hljs-string">&quot;DangDang&quot;</span>),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetMall</span>(<span class="hljs-string">&quot;TianMao&quot;</span>)<br>    );<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title function_">getPriceByStep</span><span class="hljs-params">(List&lt;NetMall&gt; list,String productName)</span>&#123;<br>        <span class="hljs-keyword">return</span> list.stream()<br>                .map(netMall -&gt; String.format(productName+<span class="hljs-string">&quot;in %s price is %.2f&quot;</span>,netMall.getMallName(),netMall.calPrice(productName)))<br>                .collect(Collectors.toList());<br>    &#125;<br><br><br>    <span class="hljs-comment">//List&lt;NetMall&gt; ----&gt;List&lt;completableFuture&lt;String&gt;&gt; ---&gt;List&lt;string&gt;</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title function_">getPriceByASync</span><span class="hljs-params">(List&lt;NetMall&gt; list,String productName)</span>&#123;<br>        <span class="hljs-keyword">return</span> list.stream()<br>                .map(netMall -&gt; CompletableFuture.supplyAsync(<br>                        () -&gt; String.format(productName + <span class="hljs-string">&quot;in %s price is %.2f&quot;</span>, netMall.getMallName(), netMall.calPrice(productName))))<br>                .collect(Collectors.toList())<br>                .stream().map(CompletableFuture::join)<br>                .collect(Collectors.toList());<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        System.out.println(<span class="hljs-string">&quot;1------------&quot;</span>);<br>        <span class="hljs-type">long</span> startTime=System.currentTimeMillis();<br>        List&lt;String&gt; list1 = getPriceByStep(list, <span class="hljs-string">&quot;mysql&quot;</span>);<br>        <span class="hljs-keyword">for</span> (String element : list1) &#123;<br>            System.out.println(element);<br>        &#125;<br>        <span class="hljs-type">long</span> endTime=System.currentTimeMillis();<br>        System.out.println(<span class="hljs-string">&quot;花费时间: &quot;</span>+(endTime-startTime)+<span class="hljs-string">&quot;毫秒&quot;</span>);<br><br><br>        System.out.println(<span class="hljs-string">&quot;2------------&quot;</span>);<br>        <span class="hljs-type">long</span> startTime2=System.currentTimeMillis();<br>        List&lt;String&gt; list2 = getPriceByASync(list, <span class="hljs-string">&quot;mysql&quot;</span>);<br>        <span class="hljs-keyword">for</span> (String element : list2) &#123;<br>            System.out.println(element);<br>        &#125;<br>        <span class="hljs-type">long</span> endTime2=System.currentTimeMillis();<br>        System.out.println(<span class="hljs-string">&quot;花费时间: &quot;</span>+(endTime2-startTime2)+<span class="hljs-string">&quot;毫秒&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetMall</span> &#123;<br>    <span class="hljs-keyword">private</span> String mallName;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMallName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> mallName;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NetMall</span><span class="hljs-params">(String mallName)</span>&#123;<br>        <span class="hljs-built_in">this</span>.mallName=mallName;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calPrice</span><span class="hljs-params">(String productName)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> ThreadLocalRandom.current().nextDouble()*<span class="hljs-number">2</span>+productName.charAt(<span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105759.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229140440119"></p>
<h2 id="CompletableFuture常用方法"><a href="#CompletableFuture常用方法" class="headerlink" title="CompletableFuture常用方法"></a>CompletableFuture常用方法</h2><h3 id="获得结果和触发计算"><a href="#获得结果和触发计算" class="headerlink" title="获得结果和触发计算"></a>获得结果和触发计算</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105800.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229142938975"></p>
<h3 id="对计算结果进行处理"><a href="#对计算结果进行处理" class="headerlink" title="对计算结果进行处理"></a>对计算结果进行处理</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105801.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229143847406"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105802.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229144356254"></p>
<h3 id="对计算结果进行消费"><a href="#对计算结果进行消费" class="headerlink" title="对计算结果进行消费"></a>对计算结果进行消费</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105803.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229145139950"></p>
<h3 id="对计算速度进行选用"><a href="#对计算速度进行选用" class="headerlink" title="对计算速度进行选用"></a>对计算速度进行选用</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105804.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229145624011"></p>
<h3 id="对计算结果进行合并"><a href="#对计算结果进行合并" class="headerlink" title="对计算结果进行合并"></a>对计算结果进行合并</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105805.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229150116909"></p>
<h3 id="家庭作业"><a href="#家庭作业" class="headerlink" title="家庭作业"></a>家庭作业</h3><p>2个作业</p>
<p>1.CompletableFuture.supplyAsync0.thenCompose()</p>
<p>2.写在简历上。</p>
<p>thenCompose() 流水线</p>
<h2 id="Java中的”锁”事"><a href="#Java中的”锁”事" class="headerlink" title="Java中的”锁”事"></a>Java中的”锁”事</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105806.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229151505483"></p>
<h3 id="乐观锁和悲观锁"><a href="#乐观锁和悲观锁" class="headerlink" title="乐观锁和悲观锁"></a>乐观锁和悲观锁</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105807.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211229151449318"></p>
<h3 id="线程八锁-锁的是什么"><a href="#线程八锁-锁的是什么" class="headerlink" title="线程八锁/锁的是什么"></a>线程八锁/锁的是什么</h3><p>根据锁的范围划分：</p>
<p>无锁、有锁；</p>
<p>锁区块、锁方法体；</p>
<p>对象锁、类锁</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105808.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230092802062"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105809.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230095354383"></p>
<p>8种锁的案例实际体现在3个地方：</p>
<p>作用于实例方法，当前实例加锁，进入向步代码前要获得当前实例的锁</p>
<p>作用于代码块，对括号里配置的对象加锁</p>
<p>作用于静态方法，当前类加锁，进去同步代码前要获得当前类对象的锁</p>
<h3 id="从自己码角度分析sync"><a href="#从自己码角度分析sync" class="headerlink" title="从自己码角度分析sync"></a>从自己码角度分析sync</h3><h4 id="sync同步代码块"><a href="#sync同步代码块" class="headerlink" title="sync同步代码块"></a>sync同步代码块</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105810.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230101007213"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105811.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230101015239"></p>
<p><strong>锁同步代码块：对象锁</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span>&#123;<br>    Object object=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    <span class="hljs-keyword">synchronized</span> (object)&#123;<br>        System.out.println(<span class="hljs-string">&quot;hello&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>锁同步代码块：类锁</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span>&#123;<br>    Object object=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    <span class="hljs-keyword">synchronized</span> (object.getClass())&#123;<br>        System.out.println(<span class="hljs-string">&quot;hello&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><code>synchronized</code> 同步语句块的实现使用的是 <code>monitorenter</code> 和 <code>monitorexit</code> 指令，</p>
<p>其中 <code>monitorenter</code> 指令指向同步代码块的开始位置，<code>monitorexit</code> 指令则指明同步代码块的结束位置。</p>
<p>当执行 <code>monitorenter</code> 指令时，线程试图获取锁也就是获取 <strong>对象监视器 <code>monitor</code></strong> 的持有权。</p>
<blockquote>
<p>在 Java 虚拟机(HotSpot)中，Monitor 是基于 C++实现的，由<a target="_blank" rel="noopener" href="https://github.com/openjdk-mirror/jdk7u-hotspot/blob/50bdefc3afe944ca74c3093e7448d6b889cd20d1/src/share/vm/runtime/objectMonitor.cpp">ObjectMonitor</a>实现的。每个对象中都内置了一个 <code>ObjectMonitor</code>对象。</p>
<p>另外，<code>wait/notify</code>等方法也依赖于<code>monitor</code>对象，这就是为什么只有在同步的块或者方法中才能调用<code>wait/notify</code>等方法，否则会抛出<code>java.lang.IllegalMonitorStateException</code>的异常的原因。</p>
</blockquote>
<p>在执行<code>monitorenter</code>时，会尝试获取对象的锁，如果锁的计数器为 0 则表示锁可以被获取，获取后将锁计数器设为 1 也就是加 1。</p>
<p>在执行 <code>monitorexit</code> 指令后，将锁计数器设为 0，表明锁被释放。如果获取对象锁失败，那当前线程就要阻塞等待，直到锁被另外一个线程释放为止。</p>
<h4 id="sync普通同步方法"><a href="#sync普通同步方法" class="headerlink" title="sync普通同步方法"></a>sync普通同步方法</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105812.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230101330077"></p>
<p><code>synchronized</code> 修饰的方法并没有 <code>monitorenter</code> 指令和 <code>monitorexit</code> 指令，取得代之的确实是 <code>ACC_SYNCHRONIZED</code> 标识，</p>
<p>该标识指明了该方法是一个同步方法。JVM 通过该 <code>ACC_SYNCHRONIZED</code> 访问标志来辨别一个方法是否声明为同步方法，从而执行相应的同步调用。</p>
<h4 id="sync锁静态同步方法"><a href="#sync锁静态同步方法" class="headerlink" title="sync锁静态同步方法"></a>sync锁静态同步方法</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105813.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230101355440"></p>
<h4 id="sync锁的是什么"><a href="#sync锁的是什么" class="headerlink" title="sync锁的是什么"></a>sync锁的是什么</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105814.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230103656628"></p>
<p>管程 (英语：Monitors，也称为监视器) 是一种程序结构，结构内的多个子程序（对象或模块）形成的多个工作线程互斥访问共享资源。</p>
<p>这些共享资源一般是硬件设备或一群变量。对共享变量能够进行的所有操作集中在一个模块中。（把信号量及其操作原语“封装”在一个对象内部）管程实现了在一个时间点，最多只有一个线程在执行管程的某个子程序。管程提供了一种机制，管程可以看做一个软件模块，它是将共享的变量和对于这些共享变量的操作封装起来，形成一个具有一定接口的功能模块，进程可以调用管程来实现进程级别的并发控制。</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105815.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230103726913"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105816.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230103852991"></p>
<h4 id="MarkWord预热"><a href="#MarkWord预热" class="headerlink" title="MarkWord预热"></a>MarkWord预热</h4><p>synchronized必须作用于某个对象中，所以Java在对象的头文件存储了锁的相关信息。锁升级功能主要依赖于 MarkWord 中的锁标志位和释放偏向锁标志位，后续讲解锁升级时候我们再加深，目前为了承前启后的学习，对下图先混个眼熟即可，O(∩_∩)O</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105817.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230104002030"></p>
<h3 id="公平锁和非公平锁"><a href="#公平锁和非公平锁" class="headerlink" title="公平锁和非公平锁"></a>公平锁和非公平锁</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105818.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230104418491"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Ticket</span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;<br>    <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sale</span><span class="hljs-params">()</span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-keyword">if</span>(number &gt; <span class="hljs-number">0</span>)<br>                System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;卖出第：\t&quot;</span>+(number--)+<span class="hljs-string">&quot;\t 还剩下:&quot;</span>+number);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SaleTicketDemo</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-type">Ticket</span> <span class="hljs-variable">ticket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Ticket</span>();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123; <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;<span class="hljs-number">35</span>; i++)  ticket.sale(); &#125;,<span class="hljs-string">&quot;a&quot;</span>).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123; <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;<span class="hljs-number">35</span>; i++)  ticket.sale(); &#125;,<span class="hljs-string">&quot;b&quot;</span>).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123; <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;<span class="hljs-number">35</span>; i++)  ticket.sale(); &#125;,<span class="hljs-string">&quot;c&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105819.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230104902630"></p>
<blockquote>
<p>为什么会有公平锁/非公平锁的设计？为什么默认非公平?</p>
</blockquote>
<p>1、恢复挂起的线程到真正锁的获取还是有时间差的，从开发人员来看这个时间微乎其微，但是从CPU的角度来看，这个时间差存在的还是很明显的。所以非公平锁能更充分的利用CPU 的时间片，尽量减少 CPU 空闲状态时间。</p>
<p>2、使用多线程很重要的考量点是线程切换的开销，<code>当采用非公平锁时，当1个线程请求锁获取同步状态，然后释放同步状态，因为不需要考虑是否还有前驱节点，所以刚释放锁的线程在此刻再次获取同步状态的概率就变得非常大，所以就减少了线程的开销。</code></p>
<blockquote>
<p>使用公平锁会有什么问题？</p>
</blockquote>
<p>公平锁保证了排队的公平性，非公平锁霸气的忽视这个规则，所以就有可能导致排队的长时间在排队，也没有机会获取到锁，</p>
<p>这就是传说中的 “锁饥饿”</p>
<blockquote>
<p>什么时候用公平？什么时候用非公平？</p>
</blockquote>
<p>如果为了更高的吞吐量，很显然非公平锁是比较合适的，因为节省很多线程切换时间，吞吐量自然就上去了；</p>
<p>否则那就用公平锁，大家公平使用。</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105820.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230105307326"></p>
<h3 id="可重入锁（递归锁）"><a href="#可重入锁（递归锁）" class="headerlink" title="可重入锁（递归锁）"></a>可重入锁（递归锁）</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105821.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230105621559"></p>
<blockquote>
<p>说明：</p>
</blockquote>
<p>可重入锁又名递归锁</p>
<p>是指在<code>同一个线程在外层方法获取锁的时候</code>，<code>再进入该线程的内层方法</code>会<code>自动获取锁(前提，锁对象得是同一个对象)</code>，不会因为之前已经获取过还没释放而阻塞。</p>
<p>如果是1个有 synchronized 修饰的递归调用方法，程序第2次进入被自己阻塞了岂不是天大的笑话，出现了<code>作茧自缚</code>。</p>
<p>所以Java中<code>ReentrantLock和synchronized都是可重入锁</code>，可重入锁的一个优点是<code>可一定程度避免死锁</code>。</p>
<h4 id="隐式的可重入锁"><a href="#隐式的可重入锁" class="headerlink" title="隐式的可重入锁"></a>隐式的可重入锁</h4><p>指的是可重复可递归调用的锁，在外层使用锁之后，在内层仍然可以使用，并且不发生死锁，这样的锁就叫做可重入锁。<br>简单的来说就是：在一个synchronized修饰的方法或代码块的内部调用本类的其他synchronized修饰的方法或代码块时，是永远可以得到锁的</p>
<p>与可重入锁相反，不可重入锁不可递归调用，递归调用就发生死锁。</p>
<p><strong>同步块</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReEntryLockDemo</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">objectLockA</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (objectLockA)&#123;<br>                System.out.println(<span class="hljs-string">&quot;-----外层调用&quot;</span>);<br>                <span class="hljs-keyword">synchronized</span> (objectLockA)&#123;<br>                    System.out.println(<span class="hljs-string">&quot;-----中层调用&quot;</span>);<br>                    <span class="hljs-keyword">synchronized</span> (objectLockA)&#123;<br>                        System.out.println(<span class="hljs-string">&quot;-----内层调用&quot;</span>);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;a&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>同步方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReEntryLockDemo</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">m1</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;-----m1&quot;</span>);<br>        m2();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">m2</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;-----m2&quot;</span>);<br>        m3();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">m3</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;-----m3&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-type">ReEntryLockDemo</span> <span class="hljs-variable">reEntryLockDemo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReEntryLockDemo</span>();<br>        reEntryLockDemo.m1();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="Synchronized的重入的实现机理"><a href="#Synchronized的重入的实现机理" class="headerlink" title="Synchronized的重入的实现机理"></a>Synchronized的重入的实现机理</h4><p><code>每个锁对象拥有一个锁计数器和一个指向持有该锁的线程的指针。</code></p>
<p>当执行monitorenter时，如果<code>目标锁对象的计数器为零</code>，那么说明它没有被其他线程所持有，Java虚拟机会将该锁对象的持有线程设置为当前线程，并且将其计数器加1。</p>
<p>在目标锁对象的计数器<code>不为零</code>的情况下，如果锁对象的<code>持有线程是当前线程</code>，那么 Java 虚拟机可以将其计数器加1，否则需要等待，直至持有线程释放该锁。</p>
<p>当<code>执行monitorexit时</code>，Java虚拟机则需将锁对象的<code>计数器减1</code>。计数器为零代表锁已被释放。</p>
<h4 id="显式的可重入锁"><a href="#显式的可重入锁" class="headerlink" title="显式的可重入锁"></a>显式的可重入锁</h4><p>加锁、解锁次数不一样的话，自己玩没事</p>
<p>多个线程一起的话，会卡住别人的线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReEntryLockDemo</span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            lock.lock();<span class="hljs-comment">//1、第一次lock</span><br>            <span class="hljs-keyword">try</span>&#123;<br>                System.out.println(<span class="hljs-string">&quot;----外层调用lock&quot;</span>);<br>                lock.lock();<span class="hljs-comment">//2、第二次lock</span><br>                <span class="hljs-keyword">try</span>&#123;<br>                    System.out.println(<span class="hljs-string">&quot;----内层调用lock&quot;</span>);<br>                &#125;<span class="hljs-keyword">finally</span> &#123;<br>                    <span class="hljs-comment">//lock.unlock(); // 正常情况，加锁几次就要解锁几次</span><br>                    <span class="hljs-comment">//正常运行，不会卡住</span><br>                &#125;<br>            &#125;<span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;a&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReEntryLockDemo</span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            lock.lock();<span class="hljs-comment">//1、第一次lock</span><br>            <span class="hljs-keyword">try</span>&#123;<br>                System.out.println(<span class="hljs-string">&quot;----外层调用lock&quot;</span>);<br>                lock.lock();<span class="hljs-comment">//2、第二次lock</span><br>                <span class="hljs-keyword">try</span>&#123;<br>                    System.out.println(<span class="hljs-string">&quot;----内层调用lock&quot;</span>);<br>                &#125;<span class="hljs-keyword">finally</span> &#123;<br>                    <span class="hljs-comment">// 这里故意注释，实现加锁次数和释放次数不一样</span><br>                    <span class="hljs-comment">// 由于加锁次数和释放次数不一样，第二个线程始终无法获取到锁，导致一直在等待。</span><br>                    <span class="hljs-comment">//lock.unlock(); // 正常情况，加锁几次就要解锁几次</span><br>                    <span class="hljs-comment">//第二个线程会卡住</span><br>                &#125;<br>            &#125;<span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;a&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span>&#123;<br>                System.out.println(<span class="hljs-string">&quot;b thread----外层调用lock&quot;</span>);<br>            &#125;<span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;b&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105822.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230132114628"></p>
<p>死锁是指两个或两个以上的线程在执行过程中,因争夺资源而造成的一种互相等待的现象,若无外力干涉那它们都将无法推进下去，如果系统资源充足，进程的资源请求都能够得到满足，死锁出现的可能性就很低，否则就会因争夺有限的资源而陷入死锁。</p>
<img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105823.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230132142765" style="zoom:67%;" />

<blockquote>
<p>手写一个死锁案例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeadLockDemo</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">objectLockA</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">objectLockB</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (objectLockA)&#123;<br>                System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t&quot;</span>+<span class="hljs-string">&quot;自己持有A，希望获得B&quot;</span>);<br>                <span class="hljs-comment">//暂停几秒钟线程</span><br>                <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>                <span class="hljs-keyword">synchronized</span> (objectLockB)&#123;<br>                    System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t&quot;</span>+<span class="hljs-string">&quot;A-------已经获得B&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;A&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (objectLockB)&#123;<br>                System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t&quot;</span>+<span class="hljs-string">&quot;自己持有B，希望获得A&quot;</span>);<br>                <span class="hljs-comment">//暂停几秒钟线程</span><br>                <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>                <span class="hljs-keyword">synchronized</span> (objectLockA)&#123;<br>                    System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t&quot;</span>+<span class="hljs-string">&quot;B-------已经获得A&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;B&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>怎么证明是死锁</p>
</blockquote>
<p>使用 jconsole 命令调出控制台</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105824.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230132652869"></p>
<p>使用 <code>jps -l</code> <code>jstack 线程ID</code> </p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105825.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230133025403"></p>
<h3 id="其他的一些锁"><a href="#其他的一些锁" class="headerlink" title="其他的一些锁"></a>其他的一些锁</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105826.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230132454587"></p>
<h2 id="线程中断机制"><a href="#线程中断机制" class="headerlink" title="线程中断机制"></a>线程中断机制</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105827.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013191213603"></p>
<h3 id="面试题反馈"><a href="#面试题反馈" class="headerlink" title="面试题反馈"></a>面试题反馈</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105828.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013191240788"></p>
<h3 id="什么是中断"><a href="#什么是中断" class="headerlink" title="什么是中断"></a>什么是中断</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105829.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013191303026"></p>
<h3 id="中断的相关API的方法"><a href="#中断的相关API的方法" class="headerlink" title="中断的相关API的方法"></a>中断的相关API的方法</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105830.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013191332009"></p>
<h3 id="如何使用中断标志停止线程"><a href="#如何使用中断标志停止线程" class="headerlink" title="如何使用中断标志停止线程"></a>如何使用中断标志停止线程</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105831.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013191407893"></p>
<h4 id="通过一个volatile变量实现"><a href="#通过一个volatile变量实现" class="headerlink" title="通过一个volatile变量实现"></a>通过一个volatile变量实现</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105832.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013191601256"></p>
<h4 id="通过AtomicBoolean"><a href="#通过AtomicBoolean" class="headerlink" title="通过AtomicBoolean"></a>通过AtomicBoolean</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105833.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013191614201"></p>
<h4 id="通过Thread类自带的中断api方法实现"><a href="#通过Thread类自带的中断api方法实现" class="headerlink" title="通过Thread类自带的中断api方法实现"></a>通过Thread类自带的中断api方法实现</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105834.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013191624282"></p>
<h3 id="interrupt源码分析"><a href="#interrupt源码分析" class="headerlink" title="interrupt源码分析"></a>interrupt源码分析</h3><p>如果一个<code>被阻塞的线程（wait()、join()、sleep()）</code>是 中断的话，将会<code>清除中断标志位（重新设置为false）</code>，并抛出<code> InterruptedException 异常</code></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105835.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013191700509"></p>
<h3 id="isInterrupted源码分析"><a href="#isInterrupted源码分析" class="headerlink" title="isInterrupted源码分析"></a>isInterrupted源码分析</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105836.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013192015150"></p>
<h3 id="Interrupt是否是立刻停止"><a href="#Interrupt是否是立刻停止" class="headerlink" title="Interrupt是否是立刻停止"></a>Interrupt是否是立刻停止</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105837.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013192148680"></p>
<blockquote>
<p> <strong>以下代码说明，当对一个线程调用Interrupt时，并不会立刻停止</strong></p>
</blockquote>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105838.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013192253768"></p>
<h3 id="后手案例"><a href="#后手案例" class="headerlink" title="后手案例"></a>后手案例</h3><h4 id="后手案例-1"><a href="#后手案例-1" class="headerlink" title="后手案例-1"></a>后手案例-1</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105839.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013192534951"></p>
<p>执行结果：</p>
<p>程序正常执行，在3秒内持续打印 hello interrupt ，3秒后，打印“***程序结束”</p>
<h4 id="后手案例-2"><a href="#后手案例-2" class="headerlink" title="后手案例-2"></a>后手案例-2</h4><p>相较于“后手案例-1”，在 while 循环内 执行休眠操作，并用 try-catch 捕获异常</p>
<p>猜测：打印六次 “hello interrupt”，打印 “***程序结束”</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105840.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013192818500"></p>
<p>运行结果：</p>
<p>报异常，程序无法停止</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105841.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013193025661"></p>
<p>出现问题的原因：</p>
<p>线程t1在休眠时，线程t2设置 t1.interrupt，导致报异常</p>
<p>报异常之后，interrupt 状态重新设置为 false ，无法停止</p>
<p>解决方案：</p>
<p>在 try-catch 中在设置一次 interrupt</p>
<h4 id="后手案例-3"><a href="#后手案例-3" class="headerlink" title="后手案例-3"></a>后手案例-3</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105842.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013193334717"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105843.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013193431140"></p>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105844.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013193522118"></p>
<h3 id="静态方法-Thread-interrupted"><a href="#静态方法-Thread-interrupted" class="headerlink" title="静态方法 Thread.interrupted"></a>静态方法 Thread.interrupted</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105845.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013193627535"></p>
<h4 id="代码演示"><a href="#代码演示" class="headerlink" title="代码演示"></a>代码演示</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105846.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013193730285"></p>
<h4 id="方法说明"><a href="#方法说明" class="headerlink" title="方法说明"></a>方法说明</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105847.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013193752806"></p>
<h3 id="Interrupted对比IsInterrupted"><a href="#Interrupted对比IsInterrupted" class="headerlink" title="Interrupted对比IsInterrupted"></a>Interrupted对比IsInterrupted</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105848.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013193928979"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105849.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013193839447"></p>
<h3 id="线程中断总结"><a href="#线程中断总结" class="headerlink" title="线程中断总结"></a>线程中断总结</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105850.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230133342947"></p>
<h2 id="加餐-要了解系统架构设计"><a href="#加餐-要了解系统架构设计" class="headerlink" title="加餐 | 要了解系统架构设计"></a>加餐 | 要了解系统架构设计</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105851.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230142150574"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105852.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230142304514"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105853.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230142208060"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105854.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230142350887"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105855.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230142425741"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105856.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230142443498"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105857.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230142508215"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105858.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230142536251"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105859.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230142733549"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105900.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230142947844"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105901.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230143055295"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105902.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230143257157"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105903.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230143309414"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112110.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230143323220"></p>
<h2 id="LockSupport"><a href="#LockSupport" class="headerlink" title="LockSupport"></a>LockSupport</h2><h3 id="什么是LockSupport"><a href="#什么是LockSupport" class="headerlink" title="什么是LockSupport"></a>什么是LockSupport</h3><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/LockSupport.html">LockSupport Java doc</a></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105904.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230143545419"></p>
<p>LockSupport是<code>用来创建锁</code>和<code>其他同步类</code>的<code>基本线程阻塞原语</code>。</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105905.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="img"></p>
<h3 id="简单说明"><a href="#简单说明" class="headerlink" title="简单说明"></a>简单说明</h3><p><strong>一句话说明LockSupport：</strong></p>
<p><strong>LockSupport就是线程等待和唤醒机制(wait/notify)的加强改良版</strong></p>
<p>LockSupport中的 <code>park()</code>和 <code>unpark()</code>的作用分别是<code>阻塞线程</code>和<code>解除阻塞线程</code>。</p>
<p>总之，比wait/notify，await/signal更强。</p>
<p><strong>3种让线程等待和唤醒的方法</strong></p>
<ul>
<li><p>方式1：使用Object中的wait()方法让线程等待，使用object中的notify()方法唤醒线程</p>
</li>
<li><p>方式2：使用JUC包中Condition的await()方法让线程等待，使用signal()方法唤醒线程</p>
</li>
<li><p>方式3：LockSupport类可以阻塞当前线程以及唤醒指定被阻塞的线程</p>
</li>
</ul>
<h3 id="两个重要方法"><a href="#两个重要方法" class="headerlink" title="两个重要方法"></a>两个重要方法</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105906.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230144502241"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105907.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230144516060"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112111.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230144736533"></p>
<h2 id="线程等待唤醒机制"><a href="#线程等待唤醒机制" class="headerlink" title="线程等待唤醒机制"></a>线程等待唤醒机制</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105908.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230143644770"></p>
<h3 id="Wait和Notify限制"><a href="#Wait和Notify限制" class="headerlink" title="Wait和Notify限制"></a>Wait和Notify限制</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105909.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230144401777"></p>
<p>Object类中的wait和notify方法实现线程等待和唤醒</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WaitNotifyDemo</span> &#123;<br><br>	<span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>	<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>		<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>			<span class="hljs-keyword">synchronized</span> (lock) &#123;<br>				System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; come in.&quot;</span>);<br>				<span class="hljs-keyword">try</span> &#123;<br>					lock.wait();<br>				&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>					e.printStackTrace();<br>				&#125;<br>			&#125;<br>			System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; 换醒.&quot;</span>);<br>		&#125;, <span class="hljs-string">&quot;Thread A&quot;</span>).start();<br>		<br>		<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>			<span class="hljs-keyword">synchronized</span> (lock) &#123;<br>				lock.notify();<br>				System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; 通知.&quot;</span>);<br>			&#125;<br>		&#125;, <span class="hljs-string">&quot;Thread B&quot;</span>).start();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>wait和notify方法<code>必须要在同步块或者方法里面</code>且<code>成对出现使用</code>，否则会抛出java.lang.IllegalMonitorStateException。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WaitNotifyDemo</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; come in.&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                lock.wait();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; 换醒.&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;Thread A&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            lock.notify();<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; 通知.&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;Thread B&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plain">Exception in thread &quot;Thread B&quot; java.lang.IllegalMonitorStateException<br>	at java.base/java.lang.Object.notify(Native Method)<br>	at com.example.demo07.main.WaitNotifyDemo.lambda<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.467ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2354 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">main</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-61" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-6D" x="0" y="0"></use>
 <use xlink:href="#E1-MJMATHI-61" x="878" y="0"></use>
 <use xlink:href="#E1-MJMATHI-69" x="1408" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1753" y="0"></use>
</g>
</svg>1(WaitNotifyDemo.java:19)<br>	at java.base/java.lang.Thread.run(Thread.java:829)<br>Thread A come in.<br>Thread A 换醒.<br>java.lang.IllegalMonitorStateException<br>	at java.base/java.lang.Object.wait(Native Method)<br>	at java.base/java.lang.Object.wait(Object.java:328)<br>	at com.example.demo07.main.WaitNotifyDemo.lambda<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.467ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2354 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">main</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-61" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-6D" x="0" y="0"></use>
 <use xlink:href="#E1-MJMATHI-61" x="878" y="0"></use>
 <use xlink:href="#E1-MJMATHI-69" x="1408" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1753" y="0"></use>
</g>
</svg>0(WaitNotifyDemo.java:11)<br>	at java.base/java.lang.Thread.run(Thread.java:829)<br></code></pre></td></tr></table></figure>



<p>调用顺序要<code>先wait后notify</code>才OK。</p>
<p>先wait后notify、notifyall方法，等待中的线程才会被唤醒，否则无法唤醒</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WaitNotifyDemo</span> &#123;<br>	<span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>		<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				Thread.sleep(<span class="hljs-number">1000</span>);<br>			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>				e.printStackTrace();<br>			&#125;<br>			<span class="hljs-keyword">synchronized</span> (lock) &#123;<br>				System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; come in.&quot;</span>);<br>				<span class="hljs-keyword">try</span> &#123;<br>					lock.wait();<br>				&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>					e.printStackTrace();<br>				&#125;<br>			&#125;<br>			System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; 换醒.&quot;</span>);<br>		&#125;, <span class="hljs-string">&quot;Thread A&quot;</span>).start();<br><br>		<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>			<span class="hljs-keyword">synchronized</span> (lock) &#123;<br>				lock.notify();<br>				System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; 通知.&quot;</span>);<br>			&#125;<br>		&#125;, <span class="hljs-string">&quot;Thread B&quot;</span>).start();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">Thread B 通知.<br>Thread A come in.<br>.......无限等待......<br></code></pre></td></tr></table></figure>



<h3 id="Await和Signal限制"><a href="#Await和Signal限制" class="headerlink" title="Await和Signal限制"></a>Await和Signal限制</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105910.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230144419994"></p>
<p>Condition接口中的await后signal方法实现线程的等待和唤醒，与Object类中的wait和notify方法实现线程等待和唤醒类似。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConditionAwaitSignalDemo</span> &#123;		<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;	<br>		<span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br>		<span class="hljs-type">Condition</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> lock.newCondition();<br>        <br>		<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;	<br>			<span class="hljs-keyword">try</span> &#123;<br>				System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; come in.&quot;</span>);<br>				lock.lock();<br>				condition.await();				<br>			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>				e.printStackTrace();<br>			&#125; <span class="hljs-keyword">finally</span> &#123;<br>				lock.unlock();<br>			&#125;<br>			System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; 换醒.&quot;</span>);<br>		&#125;,<span class="hljs-string">&quot;Thread A&quot;</span>).start();<br>		<br>		<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				lock.lock();<br>				condition.signal();<br>				System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; 通知.&quot;</span>);<br>			&#125;<span class="hljs-keyword">finally</span> &#123;<br>				lock.unlock();<br>			&#125;<br>		&#125;,<span class="hljs-string">&quot;Thread B&quot;</span>).start();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">Thread A come in.<br>Thread B 通知.<br>Thread A 换醒.<br></code></pre></td></tr></table></figure>

<p>await和signal方法<code>必须要在同步块或者方法里面</code>且成对出现使用，否则会抛出 java.lang.IllegalMonitorStateException。</p>
<p>调用顺序要<code>先await后signal</code>才OK。</p>
<h3 id="LockSupport方法介绍"><a href="#LockSupport方法介绍" class="headerlink" title="LockSupport方法介绍"></a>LockSupport方法介绍</h3><p>API中的LockSupport方法摘要</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105911.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="img"></p>
<p><strong>传统的 synchronized 和 Lock 实现等待唤醒通知的约束</strong></p>
<ul>
<li>线程先要获得并持有锁，必须在锁块(synchronized或lock)中</li>
<li>必须要先等待后唤醒，线程才能够被唤醒</li>
</ul>
<p>LockSupport类中的park等待和unpark唤醒</p>
<p>Basic thread blocking primitives for creating locks and other synchronization classes.</p>
<p>This class associates, with each thread that uses it, a permit (in the sense of the <code>Semaphore</code> class). A call to <code>park</code> will return immediately if the permit is available, consuming it in the process; otherwise it <em>may</em> block. A call to <code>unpark</code> makes the permit available, if it was not already available. (Unlike with Semaphores though, permits do not accumulate. There is at most one.) <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/LockSupport.html">link</a></p>
<p><strong>LockSupport是用来创建锁和其他同步类的基本线程阻塞原语。</strong></p>
<p>LockSupport类使用了一种名为<strong>Permit（许可）的概念</strong>来做到阻塞和唤醒线程的功能，每个线程都有一个许可（permit），permit只有两个值1和零，默认是零。</p>
<p>可以把许可看成是一种(0.1)信号量（Semaphore），但与Semaphore不同的是，<strong>许可的累加上限是1。</strong></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105912.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211230145212290"></p>
<p><strong>通过park()和unpark(thread)方法来实现阻塞和唤醒线程的操作</strong></p>
<p>park()/park(Object blocker) - 阻塞当前线程阻塞传入的具体线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockSupport</span> &#123;<br>    ...<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">park</span><span class="hljs-params">()</span> &#123;<br>        UNSAFE.park(<span class="hljs-literal">false</span>, <span class="hljs-number">0L</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">park</span><span class="hljs-params">(Object blocker)</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>        setBlocker(t, blocker);<br>        UNSAFE.park(<span class="hljs-literal">false</span>, <span class="hljs-number">0L</span>);<br>        setBlocker(t, <span class="hljs-literal">null</span>);<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>



<p>permit默认是0，所以一开始调用park()方法，当前线程就会阻塞，直到别的线程将当前线程的permit设置为1时，park方法会被唤醒，然后会将permit再次设置为0并返回。</p>
<p>unpark(Thread thread) - 唤醒处于阻塞状态的指定线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockSupport</span> &#123;<br>    ...<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unpark</span><span class="hljs-params">(Thread thread)</span> &#123;<br>        <span class="hljs-keyword">if</span> (thread != <span class="hljs-literal">null</span>)<br>            UNSAFE.unpark(thread);<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用unpark(thread)方法后，就会将thread线程的许可permit设置成1（注意多次调用unpark方法，不会累加，pemit值还是1）会自动唤醒thead线程，即之前阻塞中的LockSupport.park()方法会立即返回。</p>
<h3 id="LockSupport案例解析"><a href="#LockSupport案例解析" class="headerlink" title="LockSupport案例解析"></a>LockSupport案例解析</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105913.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="img"></p>
<blockquote>
<p><strong>正常使用</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockSupportDemo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; come in. &quot;</span> + System.currentTimeMillis());<br>            LockSupport.park();<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; 换醒. &quot;</span> + System.currentTimeMillis());<br>        &#125;, <span class="hljs-string">&quot;Thread A&quot;</span>);<br>        a.start();<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            LockSupport.unpark(a);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; 通知.&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;Thread B&quot;</span>);<br>        b.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">Thread A come in.<br>Thread B 通知.<br>Thread A 换醒.<br></code></pre></td></tr></table></figure>

<p>正常 + 无锁块要求。</p>
<p>先前错误的先唤醒后等待顺序，LockSupport可无视这顺序。</p>
<blockquote>
<p>【支持】先执行释放锁的操作unpark，后加锁</p>
</blockquote>
<p><strong>为什么可以先唤醒线程后阻塞线程？</strong></p>
<p>因为unpark获得了一个凭证，之后再调用park方法，就可以名正言顺的凭证消费，故不会阻塞。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockSupportDemo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; come in. &quot;</span> + System.currentTimeMillis());<br>            LockSupport.park();<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; 换醒. &quot;</span> + System.currentTimeMillis());<br>        &#125;, <span class="hljs-string">&quot;Thread A&quot;</span>);<br>        a.start();<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            LockSupport.unpark(a);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; 通知.&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;Thread B&quot;</span>);<br>        b.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>【支持】unpack多次</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockSupportDemo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; come in. &quot;</span> + System.currentTimeMillis());<br>            LockSupport.park();<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; 换醒. &quot;</span> + System.currentTimeMillis());<br>        &#125;, <span class="hljs-string">&quot;Thread A&quot;</span>);<br>        a.start();<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            LockSupport.unpark(a);<br>            LockSupport.unpark(a);<br>            LockSupport.unpark(a);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; 通知.&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;Thread B&quot;</span>);<br>        b.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>【不支持】pack多次，导致无限等待</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockSupportDemo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; come in. &quot;</span> + System.currentTimeMillis());<br>            LockSupport.park();<br>            LockSupport.park();<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; 换醒. &quot;</span> + System.currentTimeMillis());<br>        &#125;, <span class="hljs-string">&quot;Thread A&quot;</span>);<br>        a.start();<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            LockSupport.unpark(a);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; 通知.&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;Thread B&quot;</span>);<br>        b.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>【支持】多个通行证，由不同的线程提供</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.juc;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.locks.LockSupport;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockSupportDemo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//park多次</span><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span>  <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; come in. &quot;</span> + System.currentTimeMillis());<br>            LockSupport.park();<br>            LockSupport.park();<br>            LockSupport.park();<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; 唤醒. &quot;</span> + System.currentTimeMillis());<br>        &#125;, <span class="hljs-string">&quot;Thread A&quot;</span>);<br>        thread1.start();<br><br>        <span class="hljs-comment">//线程B unpark一次</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            LockSupport.unpark(thread1);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; 通知.&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;Thread B&quot;</span>).start();<br><br>        <span class="hljs-comment">//线程C unpark一次</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            LockSupport.unpark(thread1);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; 通知.&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;Thread C&quot;</span>).start();<br><br>        <span class="hljs-comment">//线程D unpark一次</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            LockSupport.unpark(thread1);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; 通知.&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;Thread D&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<blockquote>
<p><strong>重点说明</strong></p>
</blockquote>
<p>LockSupport是用来创建锁和共他同步类的基本线程阻塞原语。</p>
<p>LockSuport是一个线程阻塞工具类，所有的方法都是静态方法，可以让线程在任意位置阻塞，阻寨之后也有对应的唤醒方法。归根结底，LockSupport调用的Unsafe中的native代码。</p>
<p><strong>LockSupport提供park()和unpark()方法实现阻塞线程和解除线程阻塞的过程</strong></p>
<p>LockSupport和每个使用它的线程都有一个许可(permit)关联。permit相当于1，0的开关，默认是0，</p>
<p>调用一次unpark就加1变成1，</p>
<p>调用一次park会消费permit，也就是将1变成0，同时park立即返回。</p>
<p>如再次调用park会变成阻塞(因为permit为零了会阻塞在这里，一直到permit变为1)，这时调用unpark会把permit置为1。每个线程都有一个相关的permit, permit最多只有一个，<strong>重复调用unpark也不会积累凭证</strong>。</p>
<blockquote>
<p><strong>形象的理解</strong></p>
</blockquote>
<p>线程阻塞需要消耗凭证(permit)，这个凭证最多只有1个。</p>
<p>当调用park方法时</p>
<ul>
<li>如果有凭证，则会直接消耗掉这个凭证然后正常退出。</li>
<li>如果无凭证，就必须阻塞等待凭证可用。</li>
</ul>
<p>而unpark则相反，它会增加一个凭证，但凭证最多只能有1个，累加无放。</p>
<blockquote>
<p><strong>面试题</strong></p>
</blockquote>
<p><strong>1、为什么可以先唤醒线程后阻塞线程？</strong></p>
<p>因为unpark获得了一个凭证，之后再调用park方法，就可以名正言顺的凭证消费，故不会阻塞。</p>
<p><strong>2、为什么唤醒两次后阻塞两次，但最终结果还会阻塞线程？</strong></p>
<p>因为凭证的数量最多为1（不能累加），连续调用两次 unpark和调用一次 unpark效果一样，只会增加一个凭证；而调用两次park却需要消费两个凭证，证不够，不能放行。</p>
<h2 id="Java内存模型值JMM"><a href="#Java内存模型值JMM" class="headerlink" title="Java内存模型值JMM"></a>Java内存模型值JMM</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105914.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013201143830"></p>
<h3 id="面试题反馈-1"><a href="#面试题反馈-1" class="headerlink" title="面试题反馈"></a>面试题反馈</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105915.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013201216815"></p>
<h3 id="计算机硬件体系结构"><a href="#计算机硬件体系结构" class="headerlink" title="计算机硬件体系结构"></a>计算机硬件体系结构</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105916.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013201253977"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105917.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013201336229"></p>
<h3 id="什么是JMM"><a href="#什么是JMM" class="headerlink" title="什么是JMM"></a>什么是JMM</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105918.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013201355896"></p>
<h3 id="JVM规范下三大特性"><a href="#JVM规范下三大特性" class="headerlink" title="JVM规范下三大特性"></a>JVM规范下三大特性</h3><h4 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105919.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013201444642"></p>
<h4 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h4><p>指一个操作是不可中断的，即多线程环境下，操作不能被其他线程干扰</p>
<h4 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105920.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013201509370"></p>
<h3 id="多线程遍历的读取过程"><a href="#多线程遍历的读取过程" class="headerlink" title="多线程遍历的读取过程"></a>多线程遍历的读取过程</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226105921.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013201630782"></p>
<h4 id="读取过程"><a href="#读取过程" class="headerlink" title="读取过程"></a>读取过程</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112112.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013201716933"></p>
<h4 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h4><p>我们定义的所有共享变量都储存在<strong>物理主内存</strong>中</p>
<p>每个线程都有自己独立的工作内存，里面保存该线程使用到的变量的副本(主内存中该变量的一份拷贝)</p>
<p>线程对共享变量所有的操作都必须先在线程自己的工作内存中进行后写回主内存，不能直接从主内存中读写(不能越级)</p>
<p>不同线程之间也无法直接访问其他线程的工作内存中的变量，线程间变量值的传递需要通过主内存来进行(同级不能相互访问)</p>
<h2 id="happens-before原则"><a href="#happens-before原则" class="headerlink" title="happens-before原则"></a>happens-before原则</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112113.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014091919624"></p>
<h3 id="x、y案例说明"><a href="#x、y案例说明" class="headerlink" title="x、y案例说明"></a>x、y案例说明</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112114.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014091939167"></p>
<h3 id="先行发生原则说明"><a href="#先行发生原则说明" class="headerlink" title="先行发生原则说明"></a>先行发生原则说明</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112115.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014092045774"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112116.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014092014938"></p>
<h3 id="happens-before八条规则"><a href="#happens-before八条规则" class="headerlink" title="happens-before八条规则"></a>happens-before八条规则</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112117.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014092112713"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112118.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014092138339"></p>
<h3 id="代码说明"><a href="#代码说明" class="headerlink" title="代码说明"></a>代码说明</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112119.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014092202674"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112120.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014092213335"></p>
<h2 id="内存屏障"><a href="#内存屏障" class="headerlink" title="内存屏障"></a>内存屏障</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112121.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014100358040"></p>
<h3 id="volatile内存语义"><a href="#volatile内存语义" class="headerlink" title="volatile内存语义"></a>volatile内存语义</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112122.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014100434379"></p>
<h3 id="什么是内存屏障"><a href="#什么是内存屏障" class="headerlink" title="什么是内存屏障"></a>什么是内存屏障</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112123.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014100538275"></p>
<p>内存屏障（也称内存栅栏，内存栅障，屏障指令等，是<code>一类同步屏障指令</code>，是CPU或编译器在<code>对内存随机访问的操作中</code>的一个同步点，使得<code>此点之前的所有读写操作</code>都执行后才可以开始执行此点之后的操作），避免代码重排序。内存屏障其实就是一种JVM指令，Java内存模型的重排规则会<code>要求Java编译器在生成JVM指令时插入特定的内存屏障指令</code>，通过这些内存屏障指令，volatle实现了Java内存模型中的可见性和有序性，但volatile无法保证原子性。</p>
<p>内存屏障之前的所有<code>写操作都要回写到主内存</code>，</p>
<p>内存屏障之后的所有<code>读操作</code>都能获得内存屏障之前的所有写操作的最新结果(实现了可见性)。</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112124.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014100605653"></p>
<h3 id="四类内存屏障源码分析"><a href="#四类内存屏障源码分析" class="headerlink" title="四类内存屏障源码分析"></a>四类内存屏障源码分析</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112125.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014100713279"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112126.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014100749867"></p>
<h3 id="四大屏障分别是什么意思"><a href="#四大屏障分别是什么意思" class="headerlink" title="四大屏障分别是什么意思"></a>四大屏障分别是什么意思</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112127.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014100842497"></p>
<h3 id="内存屏障插入策略"><a href="#内存屏障插入策略" class="headerlink" title="内存屏障插入策略"></a>内存屏障插入策略</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112128.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014103438016"></p>
<h4 id="happens-before之volatile变量规则"><a href="#happens-before之volatile变量规则" class="headerlink" title="happens-before之volatile变量规则"></a>happens-before之volatile变量规则</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112129.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014103546032"></p>
<h4 id="写总结"><a href="#写总结" class="headerlink" title="写总结"></a>写总结</h4><p>1、在每个volatile 写操作的前面插入一个StoreStore屏障</p>
<p>2、在每个volatile 写操作的后面插入一个StoreLoad屏障</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112130.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014103911526"></p>
<h4 id="读总结"><a href="#读总结" class="headerlink" title="读总结"></a>读总结</h4><p>3、在每个volatile读操作的后面插入一个LoadLoad屏障</p>
<p>4、在每个volatile读操作的后面插入一个LoadStore屏障</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112131.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014104016981"></p>
<h2 id="volatile关键字"><a href="#volatile关键字" class="headerlink" title="volatile关键字"></a>volatile关键字</h2><h3 id="保证可见性"><a href="#保证可见性" class="headerlink" title="保证可见性"></a>保证可见性</h3><h4 id="代码说明-1"><a href="#代码说明-1" class="headerlink" title="代码说明"></a>代码说明</h4><p>不加volatile，没有可见性，程序无法停止</p>
<p>加了volatile，保证可见性，程序可以停止</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112132.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014113253889"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112133.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014113323752"></p>
<h4 id="volatile变量的读写过程"><a href="#volatile变量的读写过程" class="headerlink" title="volatile变量的读写过程"></a>volatile变量的读写过程</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112134.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014113351616"></p>
<hr>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112135.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211227140218862"></p>
<ul>
<li>lock(锁定)，作用于<strong>主内存</strong>中的变量，把变量标识为线程独占的状态。</li>
<li>read(读取)，作用于<strong>主内存</strong>的变量，把变量的值从主内存传输到线程的工作内存中，以便下一步的load操作使用。</li>
<li>load(加载)，作用于<strong>工作内存</strong>的变量，把read操作主存的变量放入到工作内存的变量副本中。</li>
<li>use(使用)，作用于<strong>工作内存</strong>的变量，把工作内存中的变量传输到执行引擎，每当虚拟机遇到一个需要使用到变量的值的字节码指令时将会执行这个操作。</li>
<li>assign(赋值)，作用于<strong>工作内存</strong>的变量，它把一个从执行引擎中接受到的值赋值给工作内存的变量副本中，每当虚拟机遇到一个给变量赋值的字节码指令时将会执行这个操作。</li>
<li>store(存储)，作用于<strong>工作内存</strong>的变量，它把一个从工作内存中一个变量的值传送到主内存中，以便后续的write使用。</li>
<li>write(写入)：作用于<strong>主内存</strong>中的变量，它把store操作从工作内存中得到的变量的值放入主内存的变量中。</li>
<li>unlock(解锁)：作用于<strong>主内存</strong>的变量，它把一个处于锁定状态的变量释放出来，释放后的变量才可以被其他线程锁定。</li>
</ul>
<h3 id="没有原子性"><a href="#没有原子性" class="headerlink" title="没有原子性"></a>没有原子性</h3><h4 id="代码演示-1"><a href="#代码演示-1" class="headerlink" title="代码演示"></a>代码演示</h4><p>输出结果：基本都会小于10000，有可能会出现一次10000</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112136.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014113441542"></p>
<h4 id="字节码角度说明"><a href="#字节码角度说明" class="headerlink" title="字节码角度说明"></a>字节码角度说明</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112137.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014113542084"></p>
<h4 id="不保证原子性"><a href="#不保证原子性" class="headerlink" title="不保证原子性"></a>不保证原子性</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112138.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014113625778"></p>
<h4 id="读取一个普通变量的情况"><a href="#读取一个普通变量的情况" class="headerlink" title="读取一个普通变量的情况"></a>读取一个普通变量的情况</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112139.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014113645474"></p>
<h4 id="volatile对指令的处理"><a href="#volatile对指令的处理" class="headerlink" title="volatile对指令的处理"></a>volatile对指令的处理</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112140.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014113730998"></p>
<h4 id="读取赋值一个volatile变量的情况"><a href="#读取赋值一个volatile变量的情况" class="headerlink" title="读取赋值一个volatile变量的情况"></a>读取赋值一个volatile变量的情况</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112141.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014113753742"></p>
<h4 id="间隙期不同非原子操作"><a href="#间隙期不同非原子操作" class="headerlink" title="间隙期不同非原子操作"></a>间隙期不同非原子操作</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112142.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014113836241"></p>
<h3 id="禁止指令重排"><a href="#禁止指令重排" class="headerlink" title="禁止指令重排"></a>禁止指令重排</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112143.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014115835644"></p>
<h4 id="说明与案例"><a href="#说明与案例" class="headerlink" title="说明与案例"></a>说明与案例</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112144.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014115920913"></p>
<h3 id="内存屏障二次复习"><a href="#内存屏障二次复习" class="headerlink" title="内存屏障二次复习"></a>内存屏障二次复习</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112145.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014120000331"></p>
<h4 id="volatile有关的禁止指令重排的行为"><a href="#volatile有关的禁止指令重排的行为" class="headerlink" title="volatile有关的禁止指令重排的行为"></a>volatile有关的禁止指令重排的行为</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112146.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014120341715"></p>
<h4 id="代码说明-2"><a href="#代码说明-2" class="headerlink" title="代码说明"></a>代码说明</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112147.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014120008815"></p>
<h2 id="正确使用volatile"><a href="#正确使用volatile" class="headerlink" title="正确使用volatile"></a>正确使用volatile</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112148.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014171532003"></p>
<h3 id="使用案例：状态标志"><a href="#使用案例：状态标志" class="headerlink" title="使用案例：状态标志"></a>使用案例：状态标志</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112149.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014171643098"></p>
<h3 id="使用案例：读多写少"><a href="#使用案例：读多写少" class="headerlink" title="使用案例：读多写少"></a>使用案例：读多写少</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112150.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014171658438"></p>
<h3 id="使用案例：双端检索"><a href="#使用案例：双端检索" class="headerlink" title="使用案例：双端检索"></a>使用案例：双端检索</h3><h4 id="问题代码"><a href="#问题代码" class="headerlink" title="问题代码"></a>问题代码</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112151.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014171843474"></p>
<h4 id="单线程、多线程下看问题代码"><a href="#单线程、多线程下看问题代码" class="headerlink" title="单线程、多线程下看问题代码"></a>单线程、多线程下看问题代码</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112152.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014171811111"></p>
<h4 id="双端检索正确代码"><a href="#双端检索正确代码" class="headerlink" title="双端检索正确代码"></a>双端检索正确代码</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112153.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014171915535"></p>
<h4 id="静态内部类实现单例模式"><a href="#静态内部类实现单例模式" class="headerlink" title="静态内部类实现单例模式"></a>静态内部类实现单例模式</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112154.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014171936749"></p>
<h2 id="volatile总结"><a href="#volatile总结" class="headerlink" title="volatile总结"></a>volatile总结</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112155.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014172038912"></p>
<h3 id="内存屏障是什么"><a href="#内存屏障是什么" class="headerlink" title="内存屏障是什么"></a>内存屏障是什么</h3><p>内存屏障：</p>
<p>是一种 <code>屏障指令</code>，它使得 <code>CPU或编译器</code> 对 <code>屏障指令的前和后</code> 所发出的内存操作 <code>执行一个排序的约束</code>。也叫内存栅栏或栅栏指令</p>
<h3 id="内存屏障四大指令"><a href="#内存屏障四大指令" class="headerlink" title="内存屏障四大指令"></a>内存屏障四大指令</h3><p>在每一个volatile写操作前面插入一个StoreStore屏障</p>
<p>在每一个volatile写操作后面插入一个StoreLoad屏障</p>
<p>在每一个volatile读操作后面插入一个LoadLoad屏障</p>
<p>在每一个volatile读操作后面插入一个LoadStore屏障</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112156.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014172234151"></p>
<h3 id="volatile关键字系统底层"><a href="#volatile关键字系统底层" class="headerlink" title="volatile关键字系统底层"></a>volatile关键字系统底层</h3><p><strong>字节码层面</strong></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112157.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014172438336"></p>
<p><strong>关键字</strong></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112158.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014172448001"></p>
<h3 id="volatile可见性"><a href="#volatile可见性" class="headerlink" title="volatile可见性"></a>volatile可见性</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112159.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014172519245"></p>
<h3 id="volatile禁重排"><a href="#volatile禁重排" class="headerlink" title="volatile禁重排"></a>volatile禁重排</h3><h4 id="写指令"><a href="#写指令" class="headerlink" title="写指令"></a>写指令</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112200.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014172658140"></p>
<h4 id="读指令"><a href="#读指令" class="headerlink" title="读指令"></a>读指令</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112201.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014172640353"></p>
<h3 id="对比Lock理解"><a href="#对比Lock理解" class="headerlink" title="对比Lock理解"></a>对比Lock理解</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112202.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014172721233"></p>
<h3 id="一句话总结"><a href="#一句话总结" class="headerlink" title="一句话总结"></a>一句话总结</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112203.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211014172800415"></p>
<h2 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112204.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015095341266"></p>
<h3 id="没有CSA之前"><a href="#没有CSA之前" class="headerlink" title="没有CSA之前"></a>没有CSA之前</h3><h4 id="多线程环境下保证线程安全"><a href="#多线程环境下保证线程安全" class="headerlink" title="多线程环境下保证线程安全"></a>多线程环境下保证线程安全</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112205.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015095423890"></p>
<h3 id="什么是CAS"><a href="#什么是CAS" class="headerlink" title="什么是CAS"></a>什么是CAS</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112206.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015095547076"></p>
<h4 id="说明和原理"><a href="#说明和原理" class="headerlink" title="说明和原理"></a>说明和原理</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112207.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015095531099"></p>
<h4 id="硬件级别的保证"><a href="#硬件级别的保证" class="headerlink" title="硬件级别的保证"></a>硬件级别的保证</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112208.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015095642550"></p>
<h4 id="CASDemo代码"><a href="#CASDemo代码" class="headerlink" title="CASDemo代码"></a>CASDemo代码</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112209.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015095657387"></p>
<h4 id="compareAndSet源码"><a href="#compareAndSet源码" class="headerlink" title="compareAndSet源码"></a>compareAndSet源码</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112210.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015095730933"></p>
<h3 id="原子引用"><a href="#原子引用" class="headerlink" title="原子引用"></a>原子引用</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112211.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015103607277"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112212.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015103622849"></p>
<h3 id="手写自旋锁"><a href="#手写自旋锁" class="headerlink" title="手写自旋锁"></a>手写自旋锁</h3><h4 id="手写自旋锁-1"><a href="#手写自旋锁-1" class="headerlink" title="手写自旋锁"></a>手写自旋锁</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112213.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015103708544"></p>
<h4 id="什么是自旋锁"><a href="#什么是自旋锁" class="headerlink" title="什么是自旋锁"></a>什么是自旋锁</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112214.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015103727183"></p>
<h3 id="ABA问题"><a href="#ABA问题" class="headerlink" title="ABA问题"></a>ABA问题</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112215.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015103814690"></p>
<h4 id="CAS的缺点：CPU空转"><a href="#CAS的缺点：CPU空转" class="headerlink" title="CAS的缺点：CPU空转"></a>CAS的缺点：CPU空转</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112216.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015103851075"></p>
<h4 id="ABA问题的产生"><a href="#ABA问题的产生" class="headerlink" title="ABA问题的产生"></a>ABA问题的产生</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112217.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015103919880"></p>
<h4 id="代码：存在ABA问题"><a href="#代码：存在ABA问题" class="headerlink" title="代码：存在ABA问题"></a>代码：存在ABA问题</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112218.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015103947131"></p>
<h4 id="代码：解决ABA问题"><a href="#代码：解决ABA问题" class="headerlink" title="代码：解决ABA问题"></a>代码：解决ABA问题</h4><p>带邮戳的原子引用：AtomicStampedReference</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">atomicStampedReference.compareAndSet(x,y,atomicStampedReference.getStamp(),atomicStampedReference.getStamp()+<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>





<p>使用：</p>
<p><strong>Class AtomicstampedReference&lt;V&gt;</strong></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112219.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015104032870"></p>
<h2 id="原子操作类"><a href="#原子操作类" class="headerlink" title="原子操作类"></a>原子操作类</h2><p>红色和黑色的有什么区别？</p>
<p>为什么要用 LongAdder 替代 AtomicLong？</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112220.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211231093302659"></p>
<h3 id="基本类型原子类"><a href="#基本类型原子类" class="headerlink" title="基本类型原子类"></a>基本类型原子类</h3><p>countDownLatch 你用在哪里？</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112221.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211231093514011"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNumber</span>&#123;<br>    <span class="hljs-meta">@Getter</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">atomicInteger</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPlusPlus</span><span class="hljs-params">()</span>&#123;<br>        atomicInteger.incrementAndGet();<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicIntegerDemo</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException&#123;<br>        <br>        <span class="hljs-type">MyNumber</span> <span class="hljs-variable">myNumber</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNumber</span>();<br>        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">countDownLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">100</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;=<span class="hljs-number">100</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>                <span class="hljs-keyword">try</span>&#123;<br>                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; j &lt;=<span class="hljs-number">5000</span>; j++)&#123;<br>                        myNumber.addPlusPlus();<br>                    &#125;<br>                &#125;<span class="hljs-keyword">finally</span> &#123;<br>                    countDownLatch.countDown();<br>                &#125;<br>            &#125;,String.valueOf(i)).start();<br>        &#125;<br><br>        countDownLatch.await();<span class="hljs-comment">//不加此行代码的话，由于main线程太快，main结束时，atomicInteger.incrementAndGet()还没算到 500000</span><br>        System.out.println(myNumber.getAtomicInteger().get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="数组类型原子类"><a href="#数组类型原子类" class="headerlink" title="数组类型原子类"></a>数组类型原子类</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112222.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211231094211978"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicIntegerArrayDemo</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <br>        <span class="hljs-type">AtomicIntegerArray</span> <span class="hljs-variable">atomicIntegerArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicIntegerArray</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">5</span>]);<br>        <span class="hljs-comment">//AtomicIntegerArray atomicIntegerArray = new AtomicIntegerArray(5);</span><br>        <span class="hljs-comment">//AtomicIntegerArray atomicIntegerArray = new AtomicIntegerArray(new int[]&#123;1,2,3,4,5&#125;);</span><br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;atomicIntegerArray.length(); i++) &#123;<br>            System.out.println(atomicIntegerArray.get(i));<br>        &#125;<br>        System.out.println();<br>        System.out.println();<br>        System.out.println();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">tmpInt</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        tmpInt = atomicIntegerArray.getAndSet(<span class="hljs-number">0</span>,<span class="hljs-number">1122</span>);<br>        System.out.println(tmpInt+<span class="hljs-string">&quot;\t&quot;</span>+atomicIntegerArray.get(<span class="hljs-number">0</span>));<br>        atomicIntegerArray.getAndIncrement(<span class="hljs-number">1</span>);<br>        atomicIntegerArray.getAndIncrement(<span class="hljs-number">1</span>);<br>        tmpInt = atomicIntegerArray.getAndIncrement(<span class="hljs-number">1</span>);<br>        System.out.println(tmpInt+<span class="hljs-string">&quot;\t&quot;</span>+atomicIntegerArray.get(<span class="hljs-number">1</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="引用类型原子类"><a href="#引用类型原子类" class="headerlink" title="引用类型原子类"></a>引用类型原子类</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112223.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211231094659460"></p>
<h4 id="AtomicReference"><a href="#AtomicReference" class="headerlink" title="AtomicReference"></a>AtomicReference</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Getter</span><br><span class="hljs-meta">@ToString</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>&#123;<br>    String userName;<br>    <span class="hljs-type">int</span>    age;<br>&#125;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicReferenceDemo</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">z3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;z3&quot;</span>,<span class="hljs-number">24</span>);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">li4</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;li4&quot;</span>,<span class="hljs-number">26</span>);<br><br>        AtomicReference&lt;User&gt; atomicReferenceUser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;();<br><br>        atomicReferenceUser.set(z3);<br>        System.out.println(atomicReferenceUser.compareAndSet(z3,li4)+<span class="hljs-string">&quot;\t&quot;</span>+atomicReferenceUser.get().toString());<br>        System.out.println(atomicReferenceUser.compareAndSet(z3,li4)+<span class="hljs-string">&quot;\t&quot;</span>+atomicReferenceUser.get().toString());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>手写自旋锁</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.Interview.study.thread;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicReference;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@auther</span> zzyy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span> 2018-12-28 17:57</span><br><span class="hljs-comment"> * 题目：实现一个自旋锁</span><br><span class="hljs-comment"> * 自旋锁好处：循环比较获取没有类似wait的阻塞。</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 通过CAS操作完成自旋锁，A线程先进来调用myLock方法自己持有锁5秒钟，B随后进来后发现</span><br><span class="hljs-comment"> * 当前有线程持有锁，不是null，所以只能通过自旋等待，直到A释放锁后B随后抢到。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpinLockDemo</span>&#123;<br>    AtomicReference&lt;Thread&gt; atomicReference = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">myLock</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t come in&quot;</span>);<br>        <span class="hljs-keyword">while</span>(!atomicReference.compareAndSet(<span class="hljs-literal">null</span>,thread))&#123;<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">myUnLock</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>        atomicReference.compareAndSet(thread,<span class="hljs-literal">null</span>);<br>        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t myUnLock over&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">SpinLockDemo</span> <span class="hljs-variable">spinLockDemo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpinLockDemo</span>();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            spinLockDemo.myLock();<br>            <span class="hljs-comment">//暂停一会儿线程</span><br>            <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep( <span class="hljs-number">5</span> ); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>            spinLockDemo.myUnLock();<br>        &#125;,<span class="hljs-string">&quot;A&quot;</span>).start();<br>        <span class="hljs-comment">//暂停一会儿线程，保证A线程先于B线程启动并完成</span><br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep( <span class="hljs-number">1</span> ); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            spinLockDemo.myLock();<br>            spinLockDemo.myUnLock();<br>        &#125;,<span class="hljs-string">&quot;B&quot;</span>).start();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="AtomicStampedReference"><a href="#AtomicStampedReference" class="headerlink" title="AtomicStampedReference"></a>AtomicStampedReference</h4><blockquote>
<p>解决ABA问题</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ABADemo</span><br>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">atomicInteger</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">100</span>);<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">AtomicStampedReference</span> <span class="hljs-variable">atomicStampedReference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicStampedReference</span>(<span class="hljs-number">100</span>,<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><br>    &#123;<br>        abaProblem();<br>        abaResolve();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">abaResolve</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> atomicStampedReference.getStamp();<br>            System.out.println(<span class="hljs-string">&quot;t3 ----第1次stamp  &quot;</span>+stamp);<br>            <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>            atomicStampedReference.compareAndSet(<span class="hljs-number">100</span>,<span class="hljs-number">101</span>,stamp,stamp+<span class="hljs-number">1</span>);<br>            System.out.println(<span class="hljs-string">&quot;t3 ----第2次stamp  &quot;</span>+atomicStampedReference.getStamp());<br>            atomicStampedReference.compareAndSet(<span class="hljs-number">101</span>,<span class="hljs-number">100</span>,atomicStampedReference.getStamp(),atomicStampedReference.getStamp()+<span class="hljs-number">1</span>);<br>            System.out.println(<span class="hljs-string">&quot;t3 ----第3次stamp  &quot;</span>+atomicStampedReference.getStamp());<br>        &#125;,<span class="hljs-string">&quot;t3&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> atomicStampedReference.getStamp();<br>            System.out.println(<span class="hljs-string">&quot;t4 ----第1次stamp  &quot;</span>+stamp);<br>            <span class="hljs-comment">//暂停几秒钟线程</span><br>            <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> atomicStampedReference.compareAndSet(<span class="hljs-number">100</span>, <span class="hljs-number">20210308</span>, stamp, stamp + <span class="hljs-number">1</span>);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t&quot;</span>+result+<span class="hljs-string">&quot;\t&quot;</span>+atomicStampedReference.getReference());<br>        &#125;,<span class="hljs-string">&quot;t4&quot;</span>).start();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">abaProblem</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            atomicInteger.compareAndSet(<span class="hljs-number">100</span>,<span class="hljs-number">101</span>);<br>            atomicInteger.compareAndSet(<span class="hljs-number">101</span>,<span class="hljs-number">100</span>);<br>        &#125;,<span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">200</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            atomicInteger.compareAndSet(<span class="hljs-number">100</span>,<span class="hljs-number">20210308</span>);<br>            System.out.println(atomicInteger.get());<br>        &#125;,<span class="hljs-string">&quot;t2&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="AtomicMarkableReference"><a href="#AtomicMarkableReference" class="headerlink" title="AtomicMarkableReference"></a>AtomicMarkableReference</h4><blockquote>
<p>不建议用来解决ABA问题</p>
<p>用来解决一次性问题，不适合重复使用</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.juc.senior.inner.atomic;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicMarkableReference;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicStampedReference;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@auther</span> zzyy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span> 2020-05-23 10:56</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ABADemo</span><br>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">atomicInteger</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">100</span>);<br>    <span class="hljs-keyword">static</span> AtomicStampedReference&lt;Integer&gt; stampedReference = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicStampedReference</span>&lt;&gt;(<span class="hljs-number">100</span>,<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">static</span> AtomicMarkableReference&lt;Integer&gt; markableReference = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicMarkableReference</span>&lt;&gt;(<span class="hljs-number">100</span>,<span class="hljs-literal">false</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><br>    &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            atomicInteger.compareAndSet(<span class="hljs-number">100</span>,<span class="hljs-number">101</span>);<br>            atomicInteger.compareAndSet(<span class="hljs-number">101</span>,<span class="hljs-number">100</span>);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t&quot;</span>+<span class="hljs-string">&quot;update ok&quot;</span>);<br>        &#125;,<span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-comment">//暂停几秒钟线程</span><br>            <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>            atomicInteger.compareAndSet(<span class="hljs-number">100</span>,<span class="hljs-number">2020</span>);<br>        &#125;,<span class="hljs-string">&quot;t2&quot;</span>).start();<br><br>        <span class="hljs-comment">//暂停几秒钟线程</span><br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">2</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br><br>        System.out.println(atomicInteger.get());<br><br>        System.out.println();<br>        System.out.println();<br>        System.out.println();<br><br>        System.out.println(<span class="hljs-string">&quot;============以下是ABA问题的解决,让我们知道引用变量中途被更改了几次=========================&quot;</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t 1次版本号&quot;</span>+stampedReference.getStamp());<br>            <span class="hljs-comment">//故意暂停200毫秒，让后面的t4线程拿到和t3一样的版本号</span><br>            <span class="hljs-keyword">try</span> &#123; TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">200</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br><br>            stampedReference.compareAndSet(<span class="hljs-number">100</span>,<span class="hljs-number">101</span>,stampedReference.getStamp(),stampedReference.getStamp()+<span class="hljs-number">1</span>);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t 2次版本号&quot;</span>+stampedReference.getStamp());<br>            stampedReference.compareAndSet(<span class="hljs-number">101</span>,<span class="hljs-number">100</span>,stampedReference.getStamp(),stampedReference.getStamp()+<span class="hljs-number">1</span>);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t 3次版本号&quot;</span>+stampedReference.getStamp());<br>        &#125;,<span class="hljs-string">&quot;t3&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> stampedReference.getStamp();<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t =======1次版本号&quot;</span>+stamp);<br>            <span class="hljs-comment">//暂停2秒钟,让t3先完成ABA操作了，看看自己还能否修改</span><br>            <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">2</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> stampedReference.compareAndSet(<span class="hljs-number">100</span>, <span class="hljs-number">2020</span>, stamp, stamp + <span class="hljs-number">1</span>);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t=======2次版本号&quot;</span>+stampedReference.getStamp()+<span class="hljs-string">&quot;\t&quot;</span>+stampedReference.getReference());<br>        &#125;,<span class="hljs-string">&quot;t4&quot;</span>).start();<br><br>        System.out.println();<br>        System.out.println();<br>        System.out.println();<br><br>        System.out.println(<span class="hljs-string">&quot;============AtomicMarkableReference不关心引用变量更改过几次，只关心是否更改过======================&quot;</span>);<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">marked</span> <span class="hljs-operator">=</span> markableReference.isMarked();<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t 1次版本号&quot;</span>+marked);<br>            <span class="hljs-keyword">try</span> &#123; TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">100</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>            markableReference.compareAndSet(<span class="hljs-number">100</span>,<span class="hljs-number">101</span>,marked,!marked);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t 2次版本号&quot;</span>+markableReference.isMarked());<br>            markableReference.compareAndSet(<span class="hljs-number">101</span>,<span class="hljs-number">100</span>,markableReference.isMarked(),!markableReference.isMarked());<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t 3次版本号&quot;</span>+markableReference.isMarked());<br>        &#125;,<span class="hljs-string">&quot;t5&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">marked</span> <span class="hljs-operator">=</span> markableReference.isMarked();<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t 1次版本号&quot;</span>+marked);<br>            <span class="hljs-comment">//暂停几秒钟线程</span><br>            <span class="hljs-keyword">try</span> &#123; TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">100</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>            markableReference.compareAndSet(<span class="hljs-number">100</span>,<span class="hljs-number">2020</span>,marked,!marked);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t&quot;</span>+markableReference.getReference()+<span class="hljs-string">&quot;\t&quot;</span>+markableReference.isMarked());<br>        &#125;,<span class="hljs-string">&quot;t6&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="对象的属性修改原子类"><a href="#对象的属性修改原子类" class="headerlink" title="对象的属性修改原子类"></a>对象的属性修改原子类</h3><p><font color=red><strong>以一种线程安全的方式操作非线程安全对象内的某些字段</strong></font></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112224.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211231100712901"></p>
<blockquote>
<p><strong>AtomicIntegerFieldUpdater</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BankAccount</span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">bankName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;CCB&quot;</span>;<span class="hljs-comment">//银行</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> <span class="hljs-variable">money</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<span class="hljs-comment">//钱数</span><br>    AtomicIntegerFieldUpdater&lt;BankAccount&gt; accountAtomicIntegerFieldUpdater = AtomicIntegerFieldUpdater.newUpdater(BankAccount.class,<span class="hljs-string">&quot;money&quot;</span>);<br><br>    <span class="hljs-comment">//不加锁+性能高，局部微创</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transferMoney</span><span class="hljs-params">(BankAccount bankAccount)</span>&#123;<br>        accountAtomicIntegerFieldUpdater.incrementAndGet(bankAccount);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@auther</span> zzyy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span> 2020-07-14 18:06</span><br><span class="hljs-comment"> * 以一种线程安全的方式操作非线程安全对象的某些字段。</span><br><span class="hljs-comment"> * 需求：</span><br><span class="hljs-comment"> * 1000个人同时向一个账号转账一元钱，那么累计应该增加1000元，</span><br><span class="hljs-comment"> * 除了synchronized和CAS,还可以使用AtomicIntegerFieldUpdater来实现。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicIntegerFieldUpdaterDemo</span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <br>        <span class="hljs-type">BankAccount</span> <span class="hljs-variable">bankAccount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BankAccount</span>();<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;=<span class="hljs-number">1000</span>; i++) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">finalI</span> <span class="hljs-operator">=</span> i;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>                bankAccount.transferMoney(bankAccount);<br>            &#125;,String.valueOf(i)).start();<br>        &#125;<br><br>        <span class="hljs-comment">//暂停毫秒</span><br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">500</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br><br>        System.out.println(bankAccount.money);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>AtomicReferenceField</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyVar</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">Boolean</span> <span class="hljs-variable">isInit</span> <span class="hljs-operator">=</span> Boolean.FALSE;<br>    AtomicReferenceFieldUpdater&lt;MyVar,Boolean&gt; atomicReferenceFieldUpdater = 	AtomicReferenceFieldUpdater.newUpdater(MyVar.class,Boolean.class,<span class="hljs-string">&quot;isInit&quot;</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(MyVar myVar)</span>&#123;<br>        <span class="hljs-keyword">if</span>(atomicReferenceFieldUpdater.compareAndSet(myVar,Boolean.FALSE,Boolean.TRUE))&#123;<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t&quot;</span>+<span class="hljs-string">&quot;---init.....&quot;</span>);<br>            <span class="hljs-comment">//暂停几秒钟线程</span><br>            <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">2</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t&quot;</span>+<span class="hljs-string">&quot;---init.....over&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t&quot;</span>+<span class="hljs-string">&quot;------其它线程正在初始化&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@auther</span> zzyy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span> 2021-03-18 17:20</span><br><span class="hljs-comment"> * 多线程并发调用一个类的初始化方法，如果未被初始化过，将执行初始化工作，要求只能初始化一次</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicIntegerFieldUpdaterDemo</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException&#123;<br>        <span class="hljs-type">MyVar</span> <span class="hljs-variable">myVar</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyVar</span>();<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;=<span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>                myVar.init(myVar);<br>            &#125;,String.valueOf(i)).start();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="原子操作增强类原理深度解析"><a href="#原子操作增强类原理深度解析" class="headerlink" title="原子操作增强类原理深度解析"></a>原子操作增强类原理深度解析</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112225.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211231105318134"></p>
<h2 id="LongAdder"><a href="#LongAdder" class="headerlink" title="LongAdder"></a>LongAdder</h2><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><blockquote>
<p><strong>阿里要命题目</strong></p>
</blockquote>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112226.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211231105432864"></p>
<blockquote>
<p><strong>常用API</strong></p>
</blockquote>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112227.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211231105955468"></p>
<h3 id="使用案例"><a href="#使用案例" class="headerlink" title="使用案例"></a>使用案例</h3><blockquote>
<p>LongAccumulator提供了自定义的函数操作</p>
</blockquote>
<p>long类型的聚合器，需要传入一个long类型的二元操作，可以用来计算各种聚合操作，包括加乘等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LongAccumulatorDemo</span><br>&#123;<br><br>    <span class="hljs-type">LongAdder</span> <span class="hljs-variable">longAdder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongAdder</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add_LongAdder</span><span class="hljs-params">()</span><br>    &#123;<br>        longAdder.increment();<br>    &#125;<br><br>    <span class="hljs-comment">//LongAccumulator longAccumulator = new LongAccumulator((x, y) -&gt; x + y,0);</span><br>    <span class="hljs-type">LongAccumulator</span> <span class="hljs-variable">longAccumulator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongAccumulator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LongBinaryOperator</span>()<br>    &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">applyAsLong</span><span class="hljs-params">(<span class="hljs-type">long</span> left, <span class="hljs-type">long</span> right)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> left - right;<br>        &#125;<br>    &#125;,<span class="hljs-number">777</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add_LongAccumulator</span><span class="hljs-params">()</span><br>    &#123;<br>        longAccumulator.accumulate(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><br>    &#123;<br>        <span class="hljs-type">LongAccumulatorDemo</span> <span class="hljs-variable">demo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongAccumulatorDemo</span>();<br><br>        demo.add_LongAccumulator();<br>        demo.add_LongAccumulator();<br>        System.out.println(demo.longAccumulator.longValue());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>LongAdderAPIDemo</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"> <br><span class="hljs-keyword">package</span> com.atguigu.juc.atomics;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.LongAccumulator;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.LongAdder;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@auther</span> zzyy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span> 2021-03-19 15:59</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LongAdderAPIDemo</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><br>    &#123;<br>        <span class="hljs-type">LongAdder</span> <span class="hljs-variable">longAdder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongAdder</span>();<br><br>        longAdder.increment();<br>        longAdder.increment();<br>        longAdder.increment();<br><br>        System.out.println(longAdder.longValue());<br><br>        <span class="hljs-type">LongAccumulator</span> <span class="hljs-variable">longAccumulator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongAccumulator</span>((x,y) -&gt; x * y,<span class="hljs-number">2</span>);<br><br>        longAccumulator.accumulate(<span class="hljs-number">1</span>);<br>        longAccumulator.accumulate(<span class="hljs-number">2</span>);<br>        longAccumulator.accumulate(<span class="hljs-number">3</span>);<br><br>        System.out.println(longAccumulator.longValue());<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h3><p><strong>1、定义五个方法</strong></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112228.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211231110759464"></p>
<p><strong>2、定义测试方法</strong></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112229.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211231110930670"></p>
<p><strong>3、测试结果</strong></p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">D: \devsoft\Javaljdk<span class="hljs-number">1.8.0_111</span>\binljava.exe<br>----costTime: <span class="hljs-number">1555</span>毫秒    add_synchronized    <span class="hljs-number">50000000</span><br>---costTime:  <span class="hljs-number">1010</span> 毫秘   add_AtomicInteger   <span class="hljs-number">50000000</span><br>----costTime: <span class="hljs-number">1056</span> 毫秒   add_AtomicLong      <span class="hljs-number">50000000</span><br>----costTime: <span class="hljs-number">162</span>毫秒     add_LongAdder       <span class="hljs-number">50000006</span><br>----costTime: <span class="hljs-number">214</span> 毫秒    add_LongAccumulator <span class="hljs-number">50000000</span><br></code></pre></td></tr></table></figure>

<h3 id="LongAdder为什么快"><a href="#LongAdder为什么快" class="headerlink" title="LongAdder为什么快"></a>LongAdder为什么快</h3><h3 id="LongAdder源码分析"><a href="#LongAdder源码分析" class="headerlink" title="LongAdder源码分析"></a>LongAdder源码分析</h3><p><font color=red><strong>太难了，暂时未看，等待后期补充【2021-12-31】</strong></font></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112230.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211231111331263"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112231.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211231111358350"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112232.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211231111408168"></p>
<h2 id="Unsafe类"><a href="#Unsafe类" class="headerlink" title="Unsafe类"></a>Unsafe类</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112233.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015095759133"></p>
<h3 id="什么是UnSafe类"><a href="#什么是UnSafe类" class="headerlink" title="什么是UnSafe类"></a>什么是UnSafe类</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112234.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015095842499"></p>
<h3 id="原子整形是否安全"><a href="#原子整形是否安全" class="headerlink" title="原子整形是否安全"></a>原子整形是否安全</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112235.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015095925331"></p>
<h3 id="getAndIncrement源码"><a href="#getAndIncrement源码" class="headerlink" title="getAndIncrement源码"></a>getAndIncrement源码</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112236.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015095952684"></p>
<h3 id="底层汇编"><a href="#底层汇编" class="headerlink" title="底层汇编"></a>底层汇编</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112237.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015100105497"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112238.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015100114590"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112239.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015100122894"></p>
<h2 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h2><h3 id="Threadlocal简介"><a href="#Threadlocal简介" class="headerlink" title="Threadlocal简介"></a>Threadlocal简介</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112240.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104093557634"></p>
<h3 id="是什么-能干啥-API"><a href="#是什么-能干啥-API" class="headerlink" title="是什么/能干啥/API"></a>是什么/能干啥/API</h3><p>ThreadLocal提供线程局部变量。这些变量与正常的变量不同，因为每一个线程在访问ThreadLocal实例的时候（通过其get或set方法〉都有自己的、独立初始化的变量副本。</p>
<p>ThreadLocal实例通常是<code>类中的私有静态字段</code>，使用它的目的是希望<code>将状态（例如，用户ID或事务ID）与线程关联起来</code>。</p>
<p>实现<code>每一个线程都有自己专属的本地变量副本</code>(自己用自己的变量不麻烦别人，不和其他人共享，人人有份，人各一份)，</p>
<p>主要解决了<code>让每个线程绑定自己的值</code>，通过使用get()和set()方法，获取默认值或将其值更改为当前线程所存的副本的值从而避免了线程安全问题。</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112241.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015114634074"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112242.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015114705321"></p>
<h3 id="案例：买房提成"><a href="#案例：买房提成" class="headerlink" title="案例：买房提成"></a>案例：买房提成</h3><h4 id="ThreadLocal初始化方法"><a href="#ThreadLocal初始化方法" class="headerlink" title="ThreadLocal初始化方法"></a>ThreadLocal初始化方法</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112243.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015114741295"></p>
<h4 id="买房提成案例"><a href="#买房提成案例" class="headerlink" title="买房提成案例"></a>买房提成案例</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112244.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015114755232"></p>
<h4 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h4><p><strong>必须回收自定义的ThreadLocal变量，尤其在线程池场景下，线程经常会被复用，</strong></p>
<p><strong>如果不清理自定义的ThreadLocal变量，可能会影响后续业务逻辑和造成内存泄露等问题。</strong></p>
<p>尽量在代理中使用try-finally块进行回收。</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112245.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015114835559"></p>
<h3 id="从阿里ThreadLocal规范开始"><a href="#从阿里ThreadLocal规范开始" class="headerlink" title="从阿里ThreadLocal规范开始"></a>从阿里ThreadLocal规范开始</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112246.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104093715736"></p>
<h3 id="非线程安全的SimpleDateFormat"><a href="#非线程安全的SimpleDateFormat" class="headerlink" title="非线程安全的SimpleDateFormat"></a>非线程安全的SimpleDateFormat</h3><h4 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112247.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015121813651"></p>
<h4 id="错误的代码演示"><a href="#错误的代码演示" class="headerlink" title="错误的代码演示"></a>错误的代码演示</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112248.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015121840093"></p>
<h4 id="出现的问题"><a href="#出现的问题" class="headerlink" title="出现的问题"></a>出现的问题</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112249.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015121932062"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112250.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015121920759"></p>
<h4 id="源码分析结论"><a href="#源码分析结论" class="headerlink" title="源码分析结论"></a>源码分析结论</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112251.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015122316518"></p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><h4 id="方案1："><a href="#方案1：" class="headerlink" title="方案1："></a>方案1：</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112252.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015122027813"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;=<span class="hljs-number">30</span>; i++) &#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<span class="hljs-comment">//每次用到的时候new</span><br>            System.out.println(sdf.parse(<span class="hljs-string">&quot;2020-11-11 11:11:11&quot;</span>));<br>            sdf = <span class="hljs-literal">null</span>;<span class="hljs-comment">//帮助GC回收</span><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;,String.valueOf(i)).start();<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="方案2："><a href="#方案2：" class="headerlink" title="方案2："></a>方案2：</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112253.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015122118700"></p>
<p><strong>代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;SimpleDateFormat&gt;  sdf_threadLocal =<br>        ThreadLocal.withInitial(()-&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));<br><br></code></pre></td></tr></table></figure>



<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112254.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015122141371"></p>
<p><strong>次解决方案来自阿里推荐</strong></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112255.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015122221608"></p>
<h4 id="其他方案："><a href="#其他方案：" class="headerlink" title="其他方案："></a>其他方案：</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112256.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015122348115"></p>
<p><strong>代码</strong></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112257.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211015122424957"></p>
<h4 id="DataUtils"><a href="#DataUtils" class="headerlink" title="DataUtils"></a>DataUtils</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.juc.senior.utils;<br><br><span class="hljs-keyword">import</span> java.text.ParseException;<br><span class="hljs-keyword">import</span> java.text.SimpleDateFormat;<br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@auther</span> zzyy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span> 2020-05-03 10:14</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateUtils</span><br>&#123;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    1   SimpleDateFormat如果多线程共用是线程不安全的类</span><br><span class="hljs-comment">    public static final SimpleDateFormat SIMPLE_DATE_FORMAT = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    public static String format(Date date)</span><br><span class="hljs-comment">    &#123;</span><br><span class="hljs-comment">        return SIMPLE_DATE_FORMAT.format(date);</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    public static Date parse(String datetime) throws ParseException</span><br><span class="hljs-comment">    &#123;</span><br><span class="hljs-comment">        return SIMPLE_DATE_FORMAT.parse(datetime);</span><br><span class="hljs-comment">    &#125;*/</span><br><br>    <span class="hljs-comment">//2   ThreadLocal可以确保每个线程都可以得到各自单独的一个SimpleDateFormat的对象，那么自然也就不存在竞争问题了。</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;SimpleDateFormat&gt; SIMPLE_DATE_FORMAT_THREAD_LOCAL = ThreadLocal.withInitial(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">format</span><span class="hljs-params">(Date date)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> SIMPLE_DATE_FORMAT_THREAD_LOCAL.get().format(date);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Date <span class="hljs-title function_">parse</span><span class="hljs-params">(String datetime)</span> <span class="hljs-keyword">throws</span> ParseException<br>    &#123;<br>        <span class="hljs-keyword">return</span> SIMPLE_DATE_FORMAT_THREAD_LOCAL.get().parse(datetime);<br>    &#125;<br><br><br>    <span class="hljs-comment">//3 DateTimeFormatter 代替 SimpleDateFormat</span><br>    <span class="hljs-comment">/*public static final DateTimeFormatter DATE_TIME_FORMAT = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    public static String format(LocalDateTime localDateTime)</span><br><span class="hljs-comment">    &#123;</span><br><span class="hljs-comment">        return DATE_TIME_FORMAT.format(localDateTime);</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    public static LocalDateTime parse(String dateString)</span><br><span class="hljs-comment">    &#123;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        return LocalDateTime.parse(dateString,DATE_TIME_FORMAT);</span><br><span class="hljs-comment">    &#125;*/</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="家庭作业-1"><a href="#家庭作业-1" class="headerlink" title="家庭作业"></a>家庭作业</h4><p>来自：阿里手册</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112258.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104100811176"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//3 DateTimeFormatter 代替 SimpleDateFormat</span><br><span class="hljs-comment">/*public static final DateTimeFormatter DATE_TIME_FORMAT = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">public static String format(LocalDateTime localDateTime)</span><br><span class="hljs-comment">&#123;</span><br><span class="hljs-comment">    return DATE_TIME_FORMAT.format(localDateTime);</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">public static LocalDateTime parse(String dateString)</span><br><span class="hljs-comment">&#123;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    return LocalDateTime.parse(dateString,DATE_TIME_FORMAT);</span><br><span class="hljs-comment">&#125;*/</span><br></code></pre></td></tr></table></figure>

<h3 id="ThreadLocal源码分析"><a href="#ThreadLocal源码分析" class="headerlink" title="ThreadLocal源码分析"></a>ThreadLocal源码分析</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112259.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104101005176"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112300.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104101300208"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112301.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104101333879"></p>
<h3 id="ThreadLocalMap"><a href="#ThreadLocalMap" class="headerlink" title="ThreadLocalMap"></a>ThreadLocalMap</h3><p><font color=red><strong>threadLocalMap实际上就是一个以threadLocal实例为key，任意对象为value的Entry对象。</strong></font></p>
<p><font color=red><strong>当我们为threadLocal变量赋值，实际上就是以当前threadLocal实例为key，值为value的Entry往这个threadLocalMap中存放</strong></font></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112302.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104101714282"></p>
<h3 id="ThreadLocal内存泄漏"><a href="#ThreadLocal内存泄漏" class="headerlink" title="ThreadLocal内存泄漏"></a>ThreadLocal内存泄漏</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112303.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104102637567"></p>
<blockquote>
<p>存在的问题：</p>
</blockquote>
<p><code>线程池环境下</code>，线程经常会被复用</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112304.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104102713615"></p>
<blockquote>
<p>什么是内存泄漏</p>
</blockquote>
<p>不再会被使用的对象或者变量占用的内存<code>不能被回收</code>，就是内存泄露。</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112305.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104102918586"></p>
<blockquote>
<p>再看ThreadLocalMap</p>
</blockquote>
<p>ThreadLocalMap从字面上就可以看出这是一个保存ThreadLocal对象的map(其实是以它为Key)不过是经过了两层包装的ThreadLocal对象:</p>
<p>(1）第一层包装是<code>使用WeakReference&lt;ThreadLoca&lt;?&gt;&gt;</code> 将ThreadLocal对象<code>变成一个弱引用的对象;</code></p>
<p>(2）第二层包装是<code>定义了一个专门的类Entry</code>来<code>扩展WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</code></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112306.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104132656644"></p>
<blockquote>
<p>整体架构</p>
</blockquote>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112307.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104132844917"></p>
<h3 id="强软弱虚四大引用"><a href="#强软弱虚四大引用" class="headerlink" title="强软弱虚四大引用"></a>强软弱虚四大引用</h3><p>当内存不足，JVM开始垃圾回收，对于强引用的对象，就算是<code>出现了OOM也不会对该对象进行回收</code>，死都不收。</p>
<p>强引用是我们<code>最常见</code>的普通对象引用，<code>只要还有强引用指向一个对象</code>，就能表明对象还“活着”，垃圾收集器不会碰这种对象。在 Java 中最常见的就是强引用，把一个对象赋给一个引用变量，这个引用变量就是一个强引用。当一个对象被强引用变量引用时，它处于可达状态，它是不可能被垃圾回收机制回收的，即使该对象以后永远都不会被用到JVM也不会回收。因此强引用是<code>造成Java内存泄漏的主要原因之一</code>。</p>
<p>对于一个普通的对象，如果没有其他的引用关系，只要超过了引用的作用域或者显式地将相应（强）引用<code>赋值为 null</code>，<br>一般认为就是可以被垃圾收集的了(当然具体回收时机还是要看垃圾收集策略)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">strongReference</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">MyObject</span> <span class="hljs-variable">myObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObject</span>();<br>    System.out.println(<span class="hljs-string">&quot;-----gc before: &quot;</span>+myObject);<br><br>    myObject = <span class="hljs-literal">null</span>;<br>    System.gc();<br>    <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br><br>    System.out.println(<span class="hljs-string">&quot;-----gc after: &quot;</span>+myObject);<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p>软引用是一种相对强引用弱化了一些的引用，需要用java.lang.ref.SoftReference类来实现，可以让对象豁免一些垃圾收集。</p>
<p>对于只有软引用的对象来说，</p>
<p>当<code>系统内存充足</code>时它      不会     被回收，</p>
<p>当<code>系统内存不足</code>时它         会     被回收。</p>
<p>软引用通常用在<code>对内存敏感的程序</code>中，比如<code>高速缓存</code>就有用到软引用，内存够用的时候就保留，不够用就回收！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyObject</span>&#123;<br>    <span class="hljs-comment">//一般开发中不用调用这个方法，本次只是为了讲课演示</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finalize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable&#123;<br>        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t&quot;</span>+<span class="hljs-string">&quot;---finalize method invoked....&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@auther</span> zzyy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span> 2021-03-24 10:31</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReferenceDemo</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-comment">//当我们内存不够用的时候，soft会被回收的情况，设置我们的内存大小：-Xms10m -Xmx10m</span><br>        SoftReference&lt;MyObject&gt; softReference = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoftReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObject</span>());<br><br>        System.gc();<br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>        System.out.println(<span class="hljs-string">&quot;-----gc after内存够用: &quot;</span>+softReference.get());<br><br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">9</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;-----gc after内存不够: &quot;</span>+softReference.get());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">strongReference</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">MyObject</span> <span class="hljs-variable">myObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObject</span>();<br>        System.out.println(<span class="hljs-string">&quot;-----gc before: &quot;</span>+myObject);<br><br>        myObject = <span class="hljs-literal">null</span>;<br>        System.gc();<br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;-----gc after: &quot;</span>+myObject);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p>弱引用需要用java.lang.ref.WeakReference类来实现，它比软引用的生存期更短，</p>
<p>对于只有弱引用的对象来说，<code>只要垃圾回收机制一运行</code>，不管JVM的内存空间是否足够，都会回收该对象占用的内存。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyObject</span><br>&#123;<br>    <span class="hljs-comment">//一般开发中不用调用这个方法，本次只是为了讲课演示</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finalize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable<br>    &#123;<br>        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t&quot;</span>+<span class="hljs-string">&quot;---finalize method invoked....&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@auther</span> zzyy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span> 2021-03-24 10:31</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReferenceDemo</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><br>    &#123;<br>        WeakReference&lt;MyObject&gt; weakReference = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObject</span>());<br>        System.out.println(<span class="hljs-string">&quot;-----gc before内存够用: &quot;</span>+weakReference.get());<br><br>        System.gc();<br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;-----gc after内存够用: &quot;</span>+weakReference.get());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">softReference</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-comment">//当我们内存不够用的时候，soft会被回收的情况，设置我们的内存大小：-Xms10m -Xmx10m</span><br>        SoftReference&lt;MyObject&gt; softReference = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoftReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObject</span>());<br><br>        System.gc();<br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>        System.out.println(<span class="hljs-string">&quot;-----gc after内存够用: &quot;</span>+softReference.get());<br><br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">9</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;-----gc after内存不够: &quot;</span>+softReference.get());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">strongReference</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-type">MyObject</span> <span class="hljs-variable">myObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObject</span>();<br>        System.out.println(<span class="hljs-string">&quot;-----gc before: &quot;</span>+myObject);<br><br>        myObject = <span class="hljs-literal">null</span>;<br>        System.gc();<br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;-----gc after: &quot;</span>+myObject);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112308.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104133420878"></p>
<hr>
<p>虚引用需要java.lang.ref.PhantomReference类来实现。</p>
<p>顾名思义，就是<code>形同虚设</code>，与其他几种引用都不同，虚引用并<code>不会决定对象的生命周期</code>。<br>如果一个对象<code>仅持有虚引用</code>，那么它就<code>和没有任何引用一样，在任何时候都可能被垃圾回收器回收，</code><br>它<code>不能单独使用</code>也<code>不能通过它访问对象</code>，虚引用必须和<code>引用队列 (ReferenceQueue)</code>联合使用。</p>
<p>虚引用的主要作用是<code>跟踪对象被垃圾回收的状态</code>。 仅仅是提供了一种<code>确保对象被 finalize以后，做某些事情的机制</code>。 PhantomReference的<code>get方法总是返回null</code>，因此无法访问对应的引用对象。</p>
<p>其意义在于：说明一个对象已经进入finalization阶段，可以被gc回收，用来实现比finalization机制更灵活的回收操作。</p>
<p>换句话说，设置虚引用关联的<code>唯一目的</code>，就是在这个<code>对象被收集器回收的时候收到一个系统通知或者后续添加进一步的处理。</code></p>
<p> <img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112309.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104133649886"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyObject</span><br>&#123;<br>    <span class="hljs-comment">//一般开发中不用调用这个方法，本次只是为了讲课演示</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finalize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable<br>    &#123;<br>        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;\t&quot;</span>+<span class="hljs-string">&quot;---finalize method invoked....&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@auther</span> zzyy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span> 2021-03-24 10:31</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReferenceDemo</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><br>    &#123;<br>        ReferenceQueue&lt;MyObject&gt; referenceQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceQueue</span>();<br>        PhantomReference&lt;MyObject&gt; phantomReference = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhantomReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObject</span>(),referenceQueue);<br>        <span class="hljs-comment">//System.out.println(phantomReference.get());</span><br><br>        List&lt;<span class="hljs-type">byte</span>[]&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<br>            &#123;<br>                list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>]);<br>                <span class="hljs-keyword">try</span> &#123; TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">600</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>                System.out.println(phantomReference.get());<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<br>            &#123;<br>                Reference&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MyObject</span>&gt; reference = referenceQueue.poll();<br>                <span class="hljs-keyword">if</span> (reference != <span class="hljs-literal">null</span>) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;***********有虚对象加入队列了&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;t2&quot;</span>).start();<br><br>        <span class="hljs-comment">//暂停几秒钟线程</span><br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">5</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">weakReference</span><span class="hljs-params">()</span><br>    &#123;<br>        WeakReference&lt;MyObject&gt; weakReference = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObject</span>());<br>        System.out.println(<span class="hljs-string">&quot;-----gc before内存够用: &quot;</span>+weakReference.get());<br><br>        System.gc();<br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;-----gc after内存够用: &quot;</span>+weakReference.get());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">softReference</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-comment">//当我们内存不够用的时候，soft会被回收的情况，设置我们的内存大小：-Xms10m -Xmx10m</span><br>        SoftReference&lt;MyObject&gt; softReference = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoftReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObject</span>());<br><br>        System.gc();<br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>        System.out.println(<span class="hljs-string">&quot;-----gc after内存够用: &quot;</span>+softReference.get());<br><br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">9</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;-----gc after内存不够: &quot;</span>+softReference.get());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">strongReference</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-type">MyObject</span> <span class="hljs-variable">myObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObject</span>();<br>        System.out.println(<span class="hljs-string">&quot;-----gc before: &quot;</span>+myObject);<br><br>        myObject = <span class="hljs-literal">null</span>;<br>        System.gc();<br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;-----gc after: &quot;</span>+myObject);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112310.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104133742871"></p>
<h3 id="为什么要用弱引用"><a href="#为什么要用弱引用" class="headerlink" title="为什么要用弱引用"></a>为什么要用弱引用</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112311.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104134029494"></p>
<hr>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112312.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104133918513"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112313.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104133959157"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112314.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104134328338"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112315.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104134433258"></p>
<hr>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112316.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104134738063"></p>
<p>结论：</p>
<p>从前面的set,getEntry,remove方法看出，在threadLocal的生命周期里，针对threadLocal存在的内存泄漏的问题，</p>
<p>都会通过expungeStaleEntry，cleanSomeSlots,replaceStaleEntry这三个方法清理掉key为null的脏entry。</p>
<h3 id="弱引用结论"><a href="#弱引用结论" class="headerlink" title="弱引用结论"></a>弱引用结论</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112317.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104134851393"></p>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112318.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220104135035912"></p>
<h2 id="Java对象内存布局和对象头"><a href="#Java对象内存布局和对象头" class="headerlink" title="Java对象内存布局和对象头"></a>Java对象内存布局和对象头</h2><h3 id="面试题反馈-2"><a href="#面试题反馈-2" class="headerlink" title="面试题反馈"></a>面试题反馈</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112319.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012185412065"></p>
<p>Object object = new Object()</p>
<p>谈谈你对这句话的理解?一般而言JDK8按照默认情况下,new一个对象占多少内存空间</p>
<h3 id="对象的内存布局"><a href="#对象的内存布局" class="headerlink" title="对象的内存布局"></a>对象的内存布局</h3><p>在HotSpot虚拟机里，<code>对象在堆内存中的存储布局</code>可以划分为三个部分：</p>
<p><code>一个对象实例</code>：对象头（Header)、实例数据（ Instance Daa）和对齐填充（Padding） </p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112320.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012185625269"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112321.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012193045120"></p>
<h3 id="对象头"><a href="#对象头" class="headerlink" title="对象头"></a>对象头</h3><p><font color=red><strong>对象头= 对象标记（MarkWord）+类元信息（类型指针）</strong></font></p>
<p>MarkWord被设计成一个非固定的数据结构</p>
<p>以便在极小的空间内存存储尽量多的数据。它会根据对象的状态复用自己的存储空间，也就是说在运行期间MarkWord里存储的数据会随着锁标志位的变化而变化。</p>
<p>默认存储：对象的HashCode、分代年龄和锁标志位等信息。</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112322.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211227162705811"></p>
<h4 id="对象标记（MarkWord）"><a href="#对象标记（MarkWord）" class="headerlink" title="对象标记（MarkWord）"></a>对象标记（MarkWord）</h4><p>它保存什么？</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112323.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012193335272"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112324.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012193346287"></p>
<p>默认存储对象的HashCode、分代年龄和锁标志位等信息。</p>
<p>这些信息都是与对象自身定义无关的数据，所以MarkWord被设计成一个非固定的数据结构</p>
<p>以便在极小的空间内存存储尽量多的数据。它会根据对象的状态复用自己的存储空间，也就是说在运行期间MarkWord里存储的数据会随着锁标志位的变化而变化。</p>
<h4 id="类元信息（类型指针）"><a href="#类元信息（类型指针）" class="headerlink" title="类元信息（类型指针）"></a>类元信息（类型指针）</h4><p>对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象是哪个类的实例。</p>
<p>参考宋红康老师JVM课程中的原图</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112325.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012193439744"></p>
<h4 id="对象头多大"><a href="#对象头多大" class="headerlink" title="对象头多大"></a>对象头多大</h4><p>在64位系统中，Mark Word占了8个字节，类型指针占了8个字节，一共是16个字节。</p>
<h3 id="实例数据"><a href="#实例数据" class="headerlink" title="实例数据"></a>实例数据</h3><p><strong>存放类的属性(Field)数据信息，包括父类的属性信息，</strong></p>
<p>如果是数组的实例部分还包括数组的长度，这部分内存按4字节对齐。</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112326.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012193707630"></p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyObject</span>&#123;<br>	<span class="hljs-built_in">int</span> i=<span class="hljs-number">5</span>;<br>	<span class="hljs-built_in">char</span> a=<span class="hljs-string">&#x27;a&#x27;</span>;<br>&#125;<br><br>MyObjec对象头 <span class="hljs-number">16</span>个字节：MarkWord <span class="hljs-number">8</span>个字节 + 类型指针 <span class="hljs-number">8</span>个字节<br><span class="hljs-built_in">int</span>类型：<span class="hljs-number">32</span>bit <span class="hljs-number">3</span>个字节<br><span class="hljs-built_in">char</span>类型：<span class="hljs-number">16</span>bit <span class="hljs-number">2</span>个字节<br>此时一共：<span class="hljs-number">16</span>+<span class="hljs-number">3</span>+<span class="hljs-number">2</span>=<span class="hljs-number">21</span>个字节<br>属性填充：<span class="hljs-number">3</span>个字节<br>一共：<span class="hljs-number">24</span>个字节<br></code></pre></td></tr></table></figure>

<h3 id="对齐填充"><a href="#对齐填充" class="headerlink" title="对齐填充"></a>对齐填充</h3><p>虚拟机要求<strong>对象起始地址必须是8字节的整数倍</strong>。</p>
<p>填充数据<strong>不是必须存在的，仅仅是为了字节对齐这部分内存按8字节补充对齐</strong>。</p>
<h2 id="对象头的MarkWord"><a href="#对象头的MarkWord" class="headerlink" title="对象头的MarkWord"></a>对象头的MarkWord</h2><h3 id="官网理论"><a href="#官网理论" class="headerlink" title="官网理论"></a>官网理论</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112327.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012194101288"></p>
<h3 id="再说对象头MarkWord"><a href="#再说对象头MarkWord" class="headerlink" title="再说对象头MarkWord"></a>再说对象头MarkWord</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112328.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012194133425"></p>
<h4 id="32位虚拟机"><a href="#32位虚拟机" class="headerlink" title="32位虚拟机"></a>32位虚拟机</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112329.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012194154484"></p>
<h4 id="64位虚拟机"><a href="#64位虚拟机" class="headerlink" title="64位虚拟机"></a>64位虚拟机</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112330.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012194209714"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112331.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012194238368"></p>
<h4 id="64位虚拟机源码"><a href="#64位虚拟机源码" class="headerlink" title="64位虚拟机源码"></a>64位虚拟机源码</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112332.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012194253289"></p>
<h2 id="对象布局说明和压缩指针"><a href="#对象布局说明和压缩指针" class="headerlink" title="对象布局说明和压缩指针"></a>对象布局说明和压缩指针</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112333.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012201849463"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112334.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012201921382"></p>
<h3 id="JOL使用案例"><a href="#JOL使用案例" class="headerlink" title="JOL使用案例"></a>JOL使用案例</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112335.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012202019923"></p>
<h4 id="new-Object代码说明"><a href="#new-Object代码说明" class="headerlink" title="new Object代码说明"></a>new Object代码说明</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112336.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012202129097"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112337.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012202207850"></p>
<h4 id="换个对象试试"><a href="#换个对象试试" class="headerlink" title="换个对象试试"></a>换个对象试试</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112338.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012202257998"></p>
<h4 id="修改GC年龄"><a href="#修改GC年龄" class="headerlink" title="修改GC年龄"></a>修改GC年龄</h4><p>GC年龄采用4位bit存储，最大值为15，使用参数修改大于15时，会报错，无法启动JVM</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112339.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012202402683"></p>
<h4 id="自动压缩"><a href="#自动压缩" class="headerlink" title="自动压缩"></a>自动压缩</h4><p>默认开启自动压缩</p>
<p>使用 打印JVM参数</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112340.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012202742428"></p>
<p>关闭自动压缩</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112341.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211012202824337"></p>
<h2 id="Synchronized锁升级"><a href="#Synchronized锁升级" class="headerlink" title="Synchronized锁升级"></a>Synchronized锁升级</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112342.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013094038359"></p>
<h3 id="面试题引入"><a href="#面试题引入" class="headerlink" title="面试题引入"></a>面试题引入</h3><p>【强制】高并发时，同步调用应该去考量锁的性能损耗。能用无锁数据结构，就不要用锁；能锁区块，就不要锁整个方法体;能用对象锁，就不要用类锁。</p>
<p>说明︰尽可能使加锁的代码块工作量尽可能的小，避免在锁代码块中调用RPC方法。</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112343.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013094115206"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112344.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013094150776"></p>
<h3 id="Synchronized的性能变化"><a href="#Synchronized的性能变化" class="headerlink" title="Synchronized的性能变化"></a>Synchronized的性能变化</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112345.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013094246274"></p>
<h3 id="为什么每一个对象都可以成为一个锁"><a href="#为什么每一个对象都可以成为一个锁" class="headerlink" title="为什么每一个对象都可以成为一个锁"></a>为什么每一个对象都可以成为一个锁</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112346.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013094401059"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112347.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013094435413"></p>
<h3 id="Monitor（监视器锁）"><a href="#Monitor（监视器锁）" class="headerlink" title="Monitor（监视器锁）"></a>Monitor（监视器锁）</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112348.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013094447226"></p>
<h3 id="Synchronized锁优化背景"><a href="#Synchronized锁优化背景" class="headerlink" title="Synchronized锁优化背景"></a>Synchronized锁优化背景</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112349.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013094614743"></p>
<h3 id="用户态和内核态"><a href="#用户态和内核态" class="headerlink" title="用户态和内核态"></a>用户态和内核态</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112350.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013094724969"></p>
<h3 id="锁升级过程"><a href="#锁升级过程" class="headerlink" title="锁升级过程"></a>锁升级过程</h3><p>==synchronized用的锁是存在Java对象头里的Mark Word中，锁升级功能主要依赖MarkWord中锁标志位和释放偏向锁标志位==</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112351.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013095018134"></p>
<h2 id="锁升级详解"><a href="#锁升级详解" class="headerlink" title="锁升级详解"></a>锁升级详解</h2><h3 id="无锁"><a href="#无锁" class="headerlink" title="无锁"></a>无锁</h3><h4 id="无锁案例"><a href="#无锁案例" class="headerlink" title="无锁案例"></a>无锁案例</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112352.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013095230223"></p>
<h4 id="hashcode有调用才会存储"><a href="#hashcode有调用才会存储" class="headerlink" title="hashcode有调用才会存储"></a>hashcode有调用才会存储</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112353.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013095334614"></p>
<h4 id="16进制下的hashcode"><a href="#16进制下的hashcode" class="headerlink" title="16进制下的hashcode"></a>16进制下的hashcode</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112354.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013095405797"></p>
<h4 id="2进制下的hashcode"><a href="#2进制下的hashcode" class="headerlink" title="2进制下的hashcode"></a>2进制下的hashcode</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112355.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013095423101"></p>
<h4 id="总结：程序不会有锁的竞争"><a href="#总结：程序不会有锁的竞争" class="headerlink" title="总结：程序不会有锁的竞争"></a>总结：程序不会有锁的竞争</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112356.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013095533001"></p>
<h3 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h3><p>什么是偏向锁：</p>
<p><code>当一段同步代码一直被同一个线程多次访问</code>，由于只有一个线程那么该线程在后续访问时便会自动获得锁</p>
<p>为什么会有偏向锁：</p>
<p>Hotspot的作者经过研究发现，<code>大多数情况下：多线程的情况下，锁不仅不存在多线程竞争，还存在锁由同一线程多次获得的情况</code>，偏向锁就是在这种情况下出现的，它的出现是<code>为了解决只有在一个线程执行同步时提高性能</code>。</p>
<p>过程说明：</p>
<p>那么只需要在锁第一次被拥有的时候，记录下偏向线程ID。这样偏向线程就一直持有着锁(后续这个线程进入和退出这段加了同步锁的代码块时，不需要再次加锁和释放锁。而是直接比较对象头里面是否存储了指向当前线程的偏向锁)。</p>
<p>如果相等表示偏向锁是偏向于当前线程的，就不需要再尝试获得锁了，直到竞争发生才释放锁。以后每次同步，检查锁的偏向线程ID与当前线程ID是否一致，<code>如果一致直接进入同步。</code>无需每次加锁解锁都去CAS更新对象头。如果自始至终使用锁的线程只有一个，很明显偏向锁几乎没有额外开销，性能极高。</p>
<p>升级为轻量级锁：</p>
<p>假如不一致意味着发生了竞争，锁已经不是总是偏向于同一个线程了，这时候可能需要升级变为轻量级锁，才能保证线程间公平竞争锁。</p>
<p><code>偏向锁只有遇到其他线程尝试竞争偏向锁时，持有偏向锁的线程才会释放锁，线程是不会主动释放偏向锁的。</code></p>
<p>偏向锁的撤销</p>
<p>竞争线程<code>尝试CAS更新对象头失败</code>，会等待到<code>全局安全点</code>（此时不会执行任何代码）撤销偏向锁。</p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112357.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013104052400"></p>
<h4 id="主要作用"><a href="#主要作用" class="headerlink" title="主要作用"></a>主要作用</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112358.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013104113759"></p>
<h4 id="64位标记图再看"><a href="#64位标记图再看" class="headerlink" title="64位标记图再看"></a>64位标记图再看</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112359.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013140221900"></p>
<h4 id="偏向锁的持有说明"><a href="#偏向锁的持有说明" class="headerlink" title="偏向锁的持有说明"></a>偏向锁的持有说明</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112400.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013140310398"></p>
<h4 id="偏向锁的举例说明"><a href="#偏向锁的举例说明" class="headerlink" title="偏向锁的举例说明"></a>偏向锁的举例说明</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112401.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013140421616"></p>
<h4 id="偏向锁JVM命令"><a href="#偏向锁JVM命令" class="headerlink" title="偏向锁JVM命令"></a>偏向锁JVM命令</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112402.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013140505059"></p>
<h4 id="偏向锁代码演示【无效果】"><a href="#偏向锁代码演示【无效果】" class="headerlink" title="偏向锁代码演示【无效果】"></a>偏向锁代码演示【无效果】</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112403.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013140554657"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112404.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013140538655"></p>
<h4 id="偏向锁代码演示【有效果】"><a href="#偏向锁代码演示【有效果】" class="headerlink" title="偏向锁代码演示【有效果】"></a>偏向锁代码演示【有效果】</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112405.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013140708554"></p>
<h4 id="偏向锁的撤销"><a href="#偏向锁的撤销" class="headerlink" title="偏向锁的撤销"></a>偏向锁的撤销</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112406.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013140739996"></p>
<h4 id="偏向锁获取撤销流程"><a href="#偏向锁获取撤销流程" class="headerlink" title="偏向锁获取撤销流程"></a>偏向锁获取撤销流程</h4><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112407.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144527645" style="zoom:67%;" />

<h3 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112408.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144131221"></p>
<h4 id="64位标记图"><a href="#64位标记图" class="headerlink" title="64位标记图"></a>64位标记图</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112409.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144212443"></p>
<h4 id="轻量级锁的获取"><a href="#轻量级锁的获取" class="headerlink" title="轻量级锁的获取"></a>轻量级锁的获取</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112410.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144238381"></p>
<h4 id="代码演示-2"><a href="#代码演示-2" class="headerlink" title="代码演示"></a>代码演示</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112411.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144306778"></p>
<h4 id="自旋到一定次数"><a href="#自旋到一定次数" class="headerlink" title="自旋到一定次数"></a>自旋到一定次数</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112412.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144352678"></p>
<h4 id="轻量级锁与偏向锁的区别和不同"><a href="#轻量级锁与偏向锁的区别和不同" class="headerlink" title="轻量级锁与偏向锁的区别和不同"></a>轻量级锁与偏向锁的区别和不同</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112413.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144409712"></p>
<h3 id="重量级锁"><a href="#重量级锁" class="headerlink" title="重量级锁"></a>重量级锁</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112414.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144613806"></p>
<h4 id="锁标志位"><a href="#锁标志位" class="headerlink" title="锁标志位"></a>锁标志位</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112415.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144705260"></p>
<h4 id="代码演示-3"><a href="#代码演示-3" class="headerlink" title="代码演示"></a>代码演示</h4><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112416.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144716981"></p>
<h3 id="锁总结"><a href="#锁总结" class="headerlink" title="锁总结"></a>锁总结</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112417.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144738215"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112418.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144754332"></p>
<h2 id="锁消除和锁粗化"><a href="#锁消除和锁粗化" class="headerlink" title="锁消除和锁粗化"></a>锁消除和锁粗化</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112419.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144839121"></p>
<h3 id="锁消除"><a href="#锁消除" class="headerlink" title="锁消除"></a>锁消除</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112420.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144904203"></p>
<h3 id="锁粗化"><a href="#锁粗化" class="headerlink" title="锁粗化"></a>锁粗化</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112421.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013144924541"></p>
<h2 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h2><h3 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h3><p><font color=red>AbstractQueuedSynchronizer</font></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112422.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220105093806917"></p>
<blockquote>
<p><strong>通过内置的FIFO队列来完成资源获取线程的排队工作，并通过一个int类变量表示持有锁的状态</strong></p>
</blockquote>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112423.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220105093407830"></p>
<blockquote>
<p>AQS相关</p>
</blockquote>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112424.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220105093527767"></p>
<h3 id="能干嘛"><a href="#能干嘛" class="headerlink" title="能干嘛"></a>能干嘛</h3><blockquote>
<p>加锁会导致阻塞 =&gt; <code>有阻塞就需要排队，实现排队必然需要队列</code></p>
</blockquote>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112425.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220105094303829"></p>
<blockquote>
<p>能干嘛：解释说明</p>
</blockquote>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112426.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220105094524031"></p>
<blockquote>
<p><font color=red><strong>AQS内部体系结构</strong></font></p>
</blockquote>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112427.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220105095103564"></p>
<blockquote>
<p>官网解释</p>
</blockquote>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112428.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220105094157634"></p>
<blockquote>
<p><font color=red><strong>AQS使用一个volatile的int类型的成员变量来表示同步状态，通过内置的FIFO队列来完成资源获取的排队工作将每条要去抢占资源的线程封装成一个Node节点来实现锁的分配，通过CAS完成对State值的修改。</strong></font></p>
</blockquote>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112429.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20220105094050754"></p>
<h2 id="ReentrantReadWriteLock"><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112430.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013153241873"></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112431.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013153358110"></p>
<h3 id="面试题引入-1"><a href="#面试题引入-1" class="headerlink" title="面试题引入"></a>面试题引入</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112432.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013153311204"></p>
<h3 id="锁得演变过程"><a href="#锁得演变过程" class="headerlink" title="锁得演变过程"></a>锁得演变过程</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112433.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013153419241"></p>
<h3 id="什么是读写锁"><a href="#什么是读写锁" class="headerlink" title="什么是读写锁"></a>什么是读写锁</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112434.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013153459517"></p>
<h3 id="锁降级说明"><a href="#锁降级说明" class="headerlink" title="锁降级说明"></a>锁降级说明</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112435.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013153631694"></p>
<h3 id="读锁和写锁互斥"><a href="#读锁和写锁互斥" class="headerlink" title="读锁和写锁互斥"></a>读锁和写锁互斥</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112436.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013160126827"></p>
<h2 id="锁降级"><a href="#锁降级" class="headerlink" title="锁降级"></a>锁降级</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112437.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013153603364"></p>
<h3 id="锁降级说明-1"><a href="#锁降级说明-1" class="headerlink" title="锁降级说明"></a>锁降级说明</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112438.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013153631694"></p>
<h3 id="Java8官网说明"><a href="#Java8官网说明" class="headerlink" title="Java8官网说明"></a>Java8官网说明</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112439.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013153729050"></p>
<h3 id="可以降级"><a href="#可以降级" class="headerlink" title="可以降级"></a>可以降级</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112440.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013153717658"></p>
<h3 id="不可锁升级"><a href="#不可锁升级" class="headerlink" title="不可锁升级"></a>不可锁升级</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112441.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013153825161"></p>
<h3 id="读写锁降级演示"><a href="#读写锁降级演示" class="headerlink" title="读写锁降级演示"></a>读写锁降级演示</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112442.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013153854646"></p>
<p><font color=red>锁可以降级，程序正常执行</font></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112443.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013153925882"></p>
<p><font color=red>程序不能正常执行，会卡住，写锁没有释放，无法获取读锁</font></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112444.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013154000848"></p>
<h3 id="持有写锁后获取读锁"><a href="#持有写锁后获取读锁" class="headerlink" title="持有写锁后获取读锁"></a>持有写锁后获取读锁</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112445.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013154746431"></p>
<h3 id="Oracle源码之锁降级"><a href="#Oracle源码之锁降级" class="headerlink" title="Oracle源码之锁降级"></a>Oracle源码之锁降级</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112446.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013160158063"></p>
<h2 id="StampedLock邮戳锁"><a href="#StampedLock邮戳锁" class="headerlink" title="StampedLock邮戳锁"></a>StampedLock邮戳锁</h2><h3 id="什么是StampedLock"><a href="#什么是StampedLock" class="headerlink" title="什么是StampedLock"></a>什么是StampedLock</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112447.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013165245758"></p>
<h3 id="什么是锁饥饿问题"><a href="#什么是锁饥饿问题" class="headerlink" title="什么是锁饥饿问题"></a>什么是锁饥饿问题</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112448.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013164511754"></p>
<h3 id="怎么缓解锁饥饿问题"><a href="#怎么缓解锁饥饿问题" class="headerlink" title="怎么缓解锁饥饿问题"></a>怎么缓解锁饥饿问题</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112449.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013164559573"></p>
<h3 id="StampedLock乐观读锁"><a href="#StampedLock乐观读锁" class="headerlink" title="StampedLock乐观读锁"></a>StampedLock乐观读锁</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112450.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013164654214"></p>
<h3 id="StampedLock的特点"><a href="#StampedLock的特点" class="headerlink" title="StampedLock的特点"></a>StampedLock的特点</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112451.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013164747555"></p>
<h3 id="StampedLock三种访问模式"><a href="#StampedLock三种访问模式" class="headerlink" title="StampedLock三种访问模式"></a>StampedLock三种访问模式</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112452.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013164836354"></p>
<h3 id="三种访问模式代码演示"><a href="#三种访问模式代码演示" class="headerlink" title="三种访问模式代码演示"></a>三种访问模式代码演示</h3><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112453.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013164953897"></p>
<h3 id="StampedLock的缺点"><a href="#StampedLock的缺点" class="headerlink" title="StampedLock的缺点"></a>StampedLock的缺点</h3><p><font color=red>StampedLock可能会导致死锁，建议不要再工作中使用，仅为了应付面试</font></p>
<p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112454.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013164856029"></p>
<h2 id="结课总结"><a href="#结课总结" class="headerlink" title="结课总结"></a>结课总结</h2><p><img   class="lazyload" data-original="https://gnotepng.oss-cn-shanghai.aliyuncs.com/20230226112455.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt="image-20211013165313322"></p>

      </section>
      <section class="extra">
        
          <ul class="copyright">
  
    <li><strong>本文作者：</strong>John Doe</li>
    <li><strong>本文链接：</strong><a href="http://example.com/2022/02/25/%E5%A4%A7%E5%8E%82%E5%AD%A6%E9%99%A2%EF%BC%9AJUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/index.html" title="http:&#x2F;&#x2F;example.com&#x2F;2022&#x2F;02&#x2F;25&#x2F;%E5%A4%A7%E5%8E%82%E5%AD%A6%E9%99%A2%EF%BC%9AJUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B&#x2F;index.html">http:&#x2F;&#x2F;example.com&#x2F;2022&#x2F;02&#x2F;25&#x2F;%E5%A4%A7%E5%8E%82%E5%AD%A6%E9%99%A2%EF%BC%9AJUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B&#x2F;index.html</a></li>
    <li><strong>版权声明：</strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" title="BY-NC-SA" target="_blank" rel="noopener">BY-NC-SA</a> 许可协议，转载请注明出处！</li>
  
</ul>
        
        
        
  <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag">并发编程</a></li></ul> 

        
  <nav class="nav">
    <a href="/2022/03/23/%E5%B0%9A%E7%A1%85%E8%B0%B7%EF%BC%9AMySQL%E7%99%BE%E7%A7%91%E5%85%A8%E4%B9%A6_%E9%AB%98%E7%BA%A7/"><i class="iconfont iconleft"></i>MySQL百科全书</a>
    <a href="/2022/01/07/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E02_%E7%BB%93%E6%9E%84%E5%9E%8B%E6%A8%A1%E5%BC%8F/">设计模式02-结构型模式<i class="iconfont iconright"></i></a>
  </nav>

      </section>
      
    </section>
  </div>
</article></div>
      <div class="col-xl-3">
        
          
  <aside class="toc-wrap">
    <h3 class="toc-title">文章目录：</h3>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B"><span class="toc-text">Java并发编程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E8%AF%B4%E6%98%8E"><span class="toc-text">课程说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E5%A4%8D%E4%B9%A0"><span class="toc-text">线程基础知识复习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%BA%E4%BB%80%E4%B9%88%E9%82%A3%E4%B9%88%E9%87%8D%E8%A6%81"><span class="toc-text">多线程为什么那么重要</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#start%E4%B8%80%E4%B8%AA%E7%BA%BF%E7%A8%8B"><span class="toc-text">start一个线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-text">Java多线程相关概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B"><span class="toc-text">用户线程和守护线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CompletableFuture"><span class="toc-text">CompletableFuture</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Future%E5%92%8CCallable%E6%8E%A5%E5%8F%A3"><span class="toc-text">Future和Callable接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FutureTask"><span class="toc-text">FutureTask</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9Future%E7%9A%84%E6%94%B9%E8%BF%9B"><span class="toc-text">对Future的改进</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set%E3%80%81get-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">set、get 的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%BD%91%E7%AB%99%E6%80%A7%E4%BB%B7%E9%9C%80%E6%B1%82"><span class="toc-text">案例：电商网站性价需求</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CompletableFuture%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-text">CompletableFuture常用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97%E7%BB%93%E6%9E%9C%E5%92%8C%E8%A7%A6%E5%8F%91%E8%AE%A1%E7%AE%97"><span class="toc-text">获得结果和触发计算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%AE%A1%E7%AE%97%E7%BB%93%E6%9E%9C%E8%BF%9B%E8%A1%8C%E5%A4%84%E7%90%86"><span class="toc-text">对计算结果进行处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%AE%A1%E7%AE%97%E7%BB%93%E6%9E%9C%E8%BF%9B%E8%A1%8C%E6%B6%88%E8%B4%B9"><span class="toc-text">对计算结果进行消费</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%AE%A1%E7%AE%97%E9%80%9F%E5%BA%A6%E8%BF%9B%E8%A1%8C%E9%80%89%E7%94%A8"><span class="toc-text">对计算速度进行选用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%AE%A1%E7%AE%97%E7%BB%93%E6%9E%9C%E8%BF%9B%E8%A1%8C%E5%90%88%E5%B9%B6"><span class="toc-text">对计算结果进行合并</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B6%E5%BA%AD%E4%BD%9C%E4%B8%9A"><span class="toc-text">家庭作业</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java%E4%B8%AD%E7%9A%84%E2%80%9D%E9%94%81%E2%80%9D%E4%BA%8B"><span class="toc-text">Java中的”锁”事</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%90%E8%A7%82%E9%94%81%E5%92%8C%E6%82%B2%E8%A7%82%E9%94%81"><span class="toc-text">乐观锁和悲观锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%85%AB%E9%94%81-%E9%94%81%E7%9A%84%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">线程八锁&#x2F;锁的是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E8%87%AA%E5%B7%B1%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90sync"><span class="toc-text">从自己码角度分析sync</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AC%E5%B9%B3%E9%94%81%E5%92%8C%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81"><span class="toc-text">公平锁和非公平锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%EF%BC%88%E9%80%92%E5%BD%92%E9%94%81%EF%BC%89"><span class="toc-text">可重入锁（递归锁）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%BB%E9%94%81"><span class="toc-text">死锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%9A%84%E4%B8%80%E4%BA%9B%E9%94%81"><span class="toc-text">其他的一些锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E4%B8%AD%E6%96%AD%E6%9C%BA%E5%88%B6"><span class="toc-text">线程中断机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98%E5%8F%8D%E9%A6%88"><span class="toc-text">面试题反馈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%AD%E6%96%AD"><span class="toc-text">什么是中断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E7%9A%84%E7%9B%B8%E5%85%B3API%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-text">中断的相关API的方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%AD%E6%A0%87%E5%BF%97%E5%81%9C%E6%AD%A2%E7%BA%BF%E7%A8%8B"><span class="toc-text">如何使用中断标志停止线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#interrupt%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">interrupt源码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#isInterrupted%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">isInterrupted源码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Interrupt%E6%98%AF%E5%90%A6%E6%98%AF%E7%AB%8B%E5%88%BB%E5%81%9C%E6%AD%A2"><span class="toc-text">Interrupt是否是立刻停止</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E6%89%8B%E6%A1%88%E4%BE%8B"><span class="toc-text">后手案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95-Thread-interrupted"><span class="toc-text">静态方法 Thread.interrupted</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Interrupted%E5%AF%B9%E6%AF%94IsInterrupted"><span class="toc-text">Interrupted对比IsInterrupted</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E4%B8%AD%E6%96%AD%E6%80%BB%E7%BB%93"><span class="toc-text">线程中断总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E9%A4%90-%E8%A6%81%E4%BA%86%E8%A7%A3%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-text">加餐 | 要了解系统架构设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LockSupport"><span class="toc-text">LockSupport</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFLockSupport"><span class="toc-text">什么是LockSupport</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E8%AF%B4%E6%98%8E"><span class="toc-text">简单说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%A4%E4%B8%AA%E9%87%8D%E8%A6%81%E6%96%B9%E6%B3%95"><span class="toc-text">两个重要方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%AD%89%E5%BE%85%E5%94%A4%E9%86%92%E6%9C%BA%E5%88%B6"><span class="toc-text">线程等待唤醒机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Wait%E5%92%8CNotify%E9%99%90%E5%88%B6"><span class="toc-text">Wait和Notify限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Await%E5%92%8CSignal%E9%99%90%E5%88%B6"><span class="toc-text">Await和Signal限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LockSupport%E6%96%B9%E6%B3%95%E4%BB%8B%E7%BB%8D"><span class="toc-text">LockSupport方法介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LockSupport%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90"><span class="toc-text">LockSupport案例解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%80%BCJMM"><span class="toc-text">Java内存模型值JMM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98%E5%8F%8D%E9%A6%88-1"><span class="toc-text">面试题反馈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A1%AC%E4%BB%B6%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-text">计算机硬件体系结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFJMM"><span class="toc-text">什么是JMM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JVM%E8%A7%84%E8%8C%83%E4%B8%8B%E4%B8%89%E5%A4%A7%E7%89%B9%E6%80%A7"><span class="toc-text">JVM规范下三大特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E9%81%8D%E5%8E%86%E7%9A%84%E8%AF%BB%E5%8F%96%E8%BF%87%E7%A8%8B"><span class="toc-text">多线程遍历的读取过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#happens-before%E5%8E%9F%E5%88%99"><span class="toc-text">happens-before原则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#x%E3%80%81y%E6%A1%88%E4%BE%8B%E8%AF%B4%E6%98%8E"><span class="toc-text">x、y案例说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%88%E8%A1%8C%E5%8F%91%E7%94%9F%E5%8E%9F%E5%88%99%E8%AF%B4%E6%98%8E"><span class="toc-text">先行发生原则说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#happens-before%E5%85%AB%E6%9D%A1%E8%A7%84%E5%88%99"><span class="toc-text">happens-before八条规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%AF%B4%E6%98%8E"><span class="toc-text">代码说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C"><span class="toc-text">内存屏障</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#volatile%E5%86%85%E5%AD%98%E8%AF%AD%E4%B9%89"><span class="toc-text">volatile内存语义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C"><span class="toc-text">什么是内存屏障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E7%B1%BB%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">四类内存屏障源码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E5%A4%A7%E5%B1%8F%E9%9A%9C%E5%88%86%E5%88%AB%E6%98%AF%E4%BB%80%E4%B9%88%E6%84%8F%E6%80%9D"><span class="toc-text">四大屏障分别是什么意思</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C%E6%8F%92%E5%85%A5%E7%AD%96%E7%95%A5"><span class="toc-text">内存屏障插入策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#volatile%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-text">volatile关键字</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E8%AF%81%E5%8F%AF%E8%A7%81%E6%80%A7"><span class="toc-text">保证可见性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B2%A1%E6%9C%89%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="toc-text">没有原子性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A6%81%E6%AD%A2%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92"><span class="toc-text">禁止指令重排</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C%E4%BA%8C%E6%AC%A1%E5%A4%8D%E4%B9%A0"><span class="toc-text">内存屏障二次复习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8volatile"><span class="toc-text">正确使用volatile</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%8A%B6%E6%80%81%E6%A0%87%E5%BF%97"><span class="toc-text">使用案例：状态标志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B%EF%BC%9A%E8%AF%BB%E5%A4%9A%E5%86%99%E5%B0%91"><span class="toc-text">使用案例：读多写少</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%8F%8C%E7%AB%AF%E6%A3%80%E7%B4%A2"><span class="toc-text">使用案例：双端检索</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#volatile%E6%80%BB%E7%BB%93"><span class="toc-text">volatile总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">内存屏障是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C%E5%9B%9B%E5%A4%A7%E6%8C%87%E4%BB%A4"><span class="toc-text">内存屏障四大指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#volatile%E5%85%B3%E9%94%AE%E5%AD%97%E7%B3%BB%E7%BB%9F%E5%BA%95%E5%B1%82"><span class="toc-text">volatile关键字系统底层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#volatile%E5%8F%AF%E8%A7%81%E6%80%A7"><span class="toc-text">volatile可见性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#volatile%E7%A6%81%E9%87%8D%E6%8E%92"><span class="toc-text">volatile禁重排</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94Lock%E7%90%86%E8%A7%A3"><span class="toc-text">对比Lock理解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%80%BB%E7%BB%93"><span class="toc-text">一句话总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CAS"><span class="toc-text">CAS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B2%A1%E6%9C%89CSA%E4%B9%8B%E5%89%8D"><span class="toc-text">没有CSA之前</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFCAS"><span class="toc-text">什么是CAS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E5%BC%95%E7%94%A8"><span class="toc-text">原子引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%86%99%E8%87%AA%E6%97%8B%E9%94%81"><span class="toc-text">手写自旋锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ABA%E9%97%AE%E9%A2%98"><span class="toc-text">ABA问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E7%B1%BB"><span class="toc-text">原子操作类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E5%8E%9F%E5%AD%90%E7%B1%BB"><span class="toc-text">基本类型原子类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B%E5%8E%9F%E5%AD%90%E7%B1%BB"><span class="toc-text">数组类型原子类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E5%8E%9F%E5%AD%90%E7%B1%BB"><span class="toc-text">引用类型原子类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7%E4%BF%AE%E6%94%B9%E5%8E%9F%E5%AD%90%E7%B1%BB"><span class="toc-text">对象的属性修改原子类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E5%A2%9E%E5%BC%BA%E7%B1%BB%E5%8E%9F%E7%90%86%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="toc-text">原子操作增强类原理深度解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LongAdder"><span class="toc-text">LongAdder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-text">使用案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-text">性能测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LongAdder%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%AB"><span class="toc-text">LongAdder为什么快</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LongAdder%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">LongAdder源码分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unsafe%E7%B1%BB"><span class="toc-text">Unsafe类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFUnSafe%E7%B1%BB"><span class="toc-text">什么是UnSafe类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%95%B4%E5%BD%A2%E6%98%AF%E5%90%A6%E5%AE%89%E5%85%A8"><span class="toc-text">原子整形是否安全</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getAndIncrement%E6%BA%90%E7%A0%81"><span class="toc-text">getAndIncrement源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%95%E5%B1%82%E6%B1%87%E7%BC%96"><span class="toc-text">底层汇编</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocal"><span class="toc-text">ThreadLocal</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Threadlocal%E7%AE%80%E4%BB%8B"><span class="toc-text">Threadlocal简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-%E8%83%BD%E5%B9%B2%E5%95%A5-API"><span class="toc-text">是什么&#x2F;能干啥&#x2F;API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E4%B9%B0%E6%88%BF%E6%8F%90%E6%88%90"><span class="toc-text">案例：买房提成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E9%98%BF%E9%87%8CThreadLocal%E8%A7%84%E8%8C%83%E5%BC%80%E5%A7%8B"><span class="toc-text">从阿里ThreadLocal规范开始</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%9A%84SimpleDateFormat"><span class="toc-text">非线程安全的SimpleDateFormat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocal%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">ThreadLocal源码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocalMap"><span class="toc-text">ThreadLocalMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocal%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F"><span class="toc-text">ThreadLocal内存泄漏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%BA%E8%BD%AF%E5%BC%B1%E8%99%9A%E5%9B%9B%E5%A4%A7%E5%BC%95%E7%94%A8"><span class="toc-text">强软弱虚四大引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8%E5%BC%B1%E5%BC%95%E7%94%A8"><span class="toc-text">为什么要用弱引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%B1%E5%BC%95%E7%94%A8%E7%BB%93%E8%AE%BA"><span class="toc-text">弱引用结论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-text">最佳实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80%E5%92%8C%E5%AF%B9%E8%B1%A1%E5%A4%B4"><span class="toc-text">Java对象内存布局和对象头</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98%E5%8F%8D%E9%A6%88-2"><span class="toc-text">面试题反馈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="toc-text">对象的内存布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%A4%B4"><span class="toc-text">对象头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E6%95%B0%E6%8D%AE"><span class="toc-text">实例数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E9%BD%90%E5%A1%AB%E5%85%85"><span class="toc-text">对齐填充</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%A4%B4%E7%9A%84MarkWord"><span class="toc-text">对象头的MarkWord</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%98%E7%BD%91%E7%90%86%E8%AE%BA"><span class="toc-text">官网理论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E8%AF%B4%E5%AF%B9%E8%B1%A1%E5%A4%B4MarkWord"><span class="toc-text">再说对象头MarkWord</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%B8%83%E5%B1%80%E8%AF%B4%E6%98%8E%E5%92%8C%E5%8E%8B%E7%BC%A9%E6%8C%87%E9%92%88"><span class="toc-text">对象布局说明和压缩指针</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JOL%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-text">JOL使用案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Synchronized%E9%94%81%E5%8D%87%E7%BA%A7"><span class="toc-text">Synchronized锁升级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98%E5%BC%95%E5%85%A5"><span class="toc-text">面试题引入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Synchronized%E7%9A%84%E6%80%A7%E8%83%BD%E5%8F%98%E5%8C%96"><span class="toc-text">Synchronized的性能变化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%AF%8F%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E9%83%BD%E5%8F%AF%E4%BB%A5%E6%88%90%E4%B8%BA%E4%B8%80%E4%B8%AA%E9%94%81"><span class="toc-text">为什么每一个对象都可以成为一个锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Monitor%EF%BC%88%E7%9B%91%E8%A7%86%E5%99%A8%E9%94%81%EF%BC%89"><span class="toc-text">Monitor（监视器锁）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Synchronized%E9%94%81%E4%BC%98%E5%8C%96%E8%83%8C%E6%99%AF"><span class="toc-text">Synchronized锁优化背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%80%81%E5%92%8C%E5%86%85%E6%A0%B8%E6%80%81"><span class="toc-text">用户态和内核态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E5%8D%87%E7%BA%A7%E8%BF%87%E7%A8%8B"><span class="toc-text">锁升级过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%81%E5%8D%87%E7%BA%A7%E8%AF%A6%E8%A7%A3"><span class="toc-text">锁升级详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E9%94%81"><span class="toc-text">无锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%8F%E5%90%91%E9%94%81"><span class="toc-text">偏向锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81"><span class="toc-text">轻量级锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81"><span class="toc-text">重量级锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E6%80%BB%E7%BB%93"><span class="toc-text">锁总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%81%E6%B6%88%E9%99%A4%E5%92%8C%E9%94%81%E7%B2%97%E5%8C%96"><span class="toc-text">锁消除和锁粗化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E6%B6%88%E9%99%A4"><span class="toc-text">锁消除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E7%B2%97%E5%8C%96"><span class="toc-text">锁粗化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AQS"><span class="toc-text">AQS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%BD%E5%B9%B2%E5%98%9B"><span class="toc-text">能干嘛</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReentrantReadWriteLock"><span class="toc-text">ReentrantReadWriteLock</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98%E5%BC%95%E5%85%A5-1"><span class="toc-text">面试题引入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E5%BE%97%E6%BC%94%E5%8F%98%E8%BF%87%E7%A8%8B"><span class="toc-text">锁得演变过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%AF%BB%E5%86%99%E9%94%81"><span class="toc-text">什么是读写锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E9%99%8D%E7%BA%A7%E8%AF%B4%E6%98%8E"><span class="toc-text">锁降级说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E9%94%81%E5%92%8C%E5%86%99%E9%94%81%E4%BA%92%E6%96%A5"><span class="toc-text">读锁和写锁互斥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%81%E9%99%8D%E7%BA%A7"><span class="toc-text">锁降级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E9%99%8D%E7%BA%A7%E8%AF%B4%E6%98%8E-1"><span class="toc-text">锁降级说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java8%E5%AE%98%E7%BD%91%E8%AF%B4%E6%98%8E"><span class="toc-text">Java8官网说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E4%BB%A5%E9%99%8D%E7%BA%A7"><span class="toc-text">可以降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E9%94%81%E5%8D%87%E7%BA%A7"><span class="toc-text">不可锁升级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E9%94%81%E9%99%8D%E7%BA%A7%E6%BC%94%E7%A4%BA"><span class="toc-text">读写锁降级演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E6%9C%89%E5%86%99%E9%94%81%E5%90%8E%E8%8E%B7%E5%8F%96%E8%AF%BB%E9%94%81"><span class="toc-text">持有写锁后获取读锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Oracle%E6%BA%90%E7%A0%81%E4%B9%8B%E9%94%81%E9%99%8D%E7%BA%A7"><span class="toc-text">Oracle源码之锁降级</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StampedLock%E9%82%AE%E6%88%B3%E9%94%81"><span class="toc-text">StampedLock邮戳锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFStampedLock"><span class="toc-text">什么是StampedLock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%94%81%E9%A5%A5%E9%A5%BF%E9%97%AE%E9%A2%98"><span class="toc-text">什么是锁饥饿问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E7%BC%93%E8%A7%A3%E9%94%81%E9%A5%A5%E9%A5%BF%E9%97%AE%E9%A2%98"><span class="toc-text">怎么缓解锁饥饿问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StampedLock%E4%B9%90%E8%A7%82%E8%AF%BB%E9%94%81"><span class="toc-text">StampedLock乐观读锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StampedLock%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-text">StampedLock的特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StampedLock%E4%B8%89%E7%A7%8D%E8%AE%BF%E9%97%AE%E6%A8%A1%E5%BC%8F"><span class="toc-text">StampedLock三种访问模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E8%AE%BF%E9%97%AE%E6%A8%A1%E5%BC%8F%E4%BB%A3%E7%A0%81%E6%BC%94%E7%A4%BA"><span class="toc-text">三种访问模式代码演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StampedLock%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-text">StampedLock的缺点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AF%BE%E6%80%BB%E7%BB%93"><span class="toc-text">结课总结</span></a></li></ol></li></ol>
  </aside>

        
      </div>
    </div>
  </div>
</main>
  

<footer class="footer">
  <div class="footer-social"><a 
        href="tencent://message/?Menu=yes&uin=894519210 "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#12B7F5'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconQQ "></i>
      </a><a 
        href="javascript:; "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#09BB07'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconwechat-fill "></i>
      </a><a 
        href="https://www.instagram.com/izhaoo/ "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#DA2E76'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconinstagram "></i>
      </a><a 
        href="https://github.com/zhaoo "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#9f7be1'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  icongithub-fill "></i>
      </a><a 
        href="mailto:izhaoo@163.com "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color=#FF3B00" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconmail"></i>
      </a></div>
  
    <div class="footer-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme - <a target="_blank" href="https://github.com/izhaoo/hexo-theme-zhaoo">zhaoo</a></p></div>
  
</footer>
  
      <div class="fab fab-plus">
    <i class="iconfont iconplus"></i>
  </div>
  
  
  
  <div class="fab fab-up">
    <i class="iconfont iconcaret-up"></i>
  </div>
  
  
  
    
<script src="/js/color-mode.js"></script>

  
  
    <div class="search">
  <div class="search-container">
    <div class="search-close">
      <i class="iconfont iconbaseline-close-px"></i>
    </div>
    <div class="search-input-wrapper">
      <i class="search-input-icon iconfont iconsearch"></i>
      <input class="search-input" type="search" id="search-input" placeholder="Search..." autofocus autocomplete="off"
        autocorrect="off" autocapitalize="off">
    </div>
    <div class="search-output" id="search-output"></div>
  </div>
</div>
  
</body>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>





  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>




  
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>






  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>




<script src="/js/utils.js"></script>
<script src="/js/script.js"></script>







  <script>
    (function () {
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>













</html>